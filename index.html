<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>警犬繁育管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 基础重置与变量定义 */
        :root {
            --primary-color: #1a56db;
            --primary-dark: #1e429f;
            --primary-light: #3f83f8;
            --secondary-color: #059669;
            --accent-color: #7c3aed;
            --danger-color: #dc2626;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            --info-color: #3b82f6;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-sidebar: #1f2937;
            --bg-card: #ffffff;
            
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            --transition: all 0.3s ease;
        }
        
        /* 暗色主题变量 */
        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-sidebar: #0f172a;
            --bg-card: #1e293b;
            
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-light: #9ca3af;
            
            --border-color: #374151;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }
        
        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white;
            padding: 1.25rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        header p {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .system-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius);
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }
        
        .system-status i {
            color: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* 主要内容区域 */
        .main-content {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 140px);
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            color: white;
            padding: 1.5rem 0;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            z-index: 90;
            flex-shrink: 0;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.25rem;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .sidebar-menu a:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border-left-color: var(--primary-light);
        }
        
        .sidebar-menu a.active {
            background: rgba(59, 130, 246, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }
        
        .sidebar-menu a i {
            width: 20px;
            font-size: 1.1rem;
        }
        
        /* 内容区域 */
        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--bg-secondary);
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .content-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }
        
        .page-title i {
            color: var(--primary-color);
        }
        
        /* 卡片样式 */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }
        
        .card h3 i {
            color: var(--primary-color);
        }
        
        /* 统计卡片 */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* 表单样式 */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group label:after {
            content: '*';
            color: var(--danger-color);
            display: none;
        }
        
        .form-group label[for*="required"]:after {
            display: inline;
        }
        
        input, select, textarea {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input:hover, select:hover {
            border-color: var(--primary-light);
        }
        
        /* 按钮样式 */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #34d399, var(--success-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #991b1b);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ef4444, var(--danger-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #fbbf24, var(--warning-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #1d4ed8);
            color: white;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #60a5fa, var(--info-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        /* 表格样式 */
        .table-container {
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-card);
        }
        
        thead {
            background: linear-gradient(135deg, var(--bg-sidebar), #374151);
        }
        
        th {
            padding: 1rem;
            text-align: left;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        tbody tr {
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }
        
        tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        td {
            padding: 1rem;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        /* 徽章样式 */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .badge-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }
        
        .badge-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }
        
        .badge-info {
            background: linear-gradient(135deg, var(--info-color), #1d4ed8);
            color: white;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }
        
        .badge-danger {
            background: linear-gradient(135deg, var(--danger-color), #991b1b);
            color: white;
        }
        
        /* 搜索框样式 */
        .search-box {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .search-box input {
            flex: 1;
            min-width: 250px;
        }
        
        /* Excel导出区域 */
        .excel-export-section {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-left: 4px solid var(--primary-color);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin: 1.5rem 0;
        }
        
        .excel-export-section h4 {
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }
        
        .excel-export-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .excel-export-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius);
            border: none;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .excel-export-btn:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        /* 提醒样式 */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border-left-color: var(--success-color);
            color: var(--success-color);
        }
        
        .alert-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-left-color: var(--warning-color);
            color: var(--warning-color);
        }
        
        .alert-danger {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
            border-left-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        .alert-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border-left-color: var(--info-color);
            color: var(--info-color);
        }
        
        /* 父母搜索样式 */
        .parent-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .parent-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .parent-search-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }
        
        .parent-search-item:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .parent-search-id {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-left: 0.5rem;
        }
        
        /* 疫苗选择样式 */
        .vaccine-quick-select {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }
        
        .vaccine-quick-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }
        
        .vaccine-quick-btn:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        
        .vaccine-quick-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .vaccine-history-list {
            margin-top: 1rem;
        }
        
        .vaccine-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }
        
        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-sidebar), #374151);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .modal-header h3 {
            color: white;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        /* 页脚样式 */
        footer {
            background: var(--bg-sidebar);
            color: var(--text-secondary);
            padding: 1.5rem 2rem;
            text-align: center;
            margin-top: auto;
        }
        
        footer p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 1rem;
            }
            
            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }
            
            .sidebar-menu li {
                flex-shrink: 0;
            }
            
            .sidebar-menu a {
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .sidebar-menu a.active {
                border-left: none;
                border-bottom: 3px solid var(--primary-color);
            }
        }
        
        @media (max-width: 768px) {
            .content-area {
                padding: 1.25rem;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .excel-export-buttons {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            header {
                padding: 1rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        /* 犬只详情行样式 */
        .dog-detail-row {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dog-detail-label {
            width: 120px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .dog-detail-value {
            flex: 1;
            color: var(--text-primary);
        }
        
        /* 状态指示器 */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-healthy {
            background-color: var(--success-color);
        }
        
        .status-pregnant {
            background-color: var(--danger-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        /* 新增：幼犬预约样式 */
        .puppy-schedule-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-left: 4px solid var(--info-color);
            padding: 1.25rem;
            border-radius: var(--radius);
            margin-top: 1rem;
        }
        
        .puppy-schedule-card h5 {
            color: var(--info-color);
            margin-bottom: 0.75rem;
        }
        
        /* 新增：母犬关联幼犬选择样式 */
        .mother-puppy-select {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }
        
        .mother-puppy-select select {
            flex: 1;
        }
        
        .puppy-list-container {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 0.75rem;
        }
        
        .puppy-option {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .puppy-option:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .puppy-option.selected {
            background-color: rgba(59, 130, 246, 0.2);
            border-left: 3px solid var(--primary-color);
        }
        
        .puppy-option input {
            margin-right: 0.5rem;
        }
        
        .puppy-info {
            flex: 1;
        }
        
        .puppy-name {
            font-weight: 500;
        }
        
        .puppy-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* 新增：犬舍号筛选样式 */
        .filter-kennel {
            min-width: 120px;
        }
        
        .kennel-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-dog"></i> 警犬繁育管理系统</h1>
                    <p>犬只档案管理 | 繁殖记录 | 免疫跟踪 | 数据统计</p>
                </div>
                <div class="system-status">
                    <i class="fas fa-circle"></i> 系统运行中
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <nav class="sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#dashboard" class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                    <li><a href="#add-dog" data-section="add-dog"><i class="fas fa-plus-circle"></i> 添加犬只</a></li>
                    <li><a href="#view-dogs" data-section="view-dogs"><i class="fas fa-list"></i> 查看犬只</a></li>
                    <li><a href="#record-heat" data-section="record-heat"><i class="fas fa-heartbeat"></i> 发情记录</a></li>
                    <li><a href="#record-breeding" data-section="record-breeding"><i class="fas fa-paw"></i> 配种记录</a></li>
                    <li><a href="#record-birth" data-section="record-birth"><i class="fas fa-baby"></i> 分娩记录</a></li>
                    <li><a href="#record-vaccination" data-section="record-vaccination"><i class="fas fa-syringe"></i> 免疫记录</a></li>
                    <li><a href="#reports" data-section="reports"><i class="fas fa-chart-bar"></i> 统计报告</a></li>
                    <li><a href="#data-management" data-section="data-management"><i class="fas fa-database"></i> 数据管理</a></li>
                </ul>
            </nav>
            
            <div class="content-area">
                <!-- 仪表盘 -->
                <div id="dashboard" class="content-section active">
                    <h2 class="page-title"><i class="fas fa-tachometer-alt"></i> 警犬总体情况</h2>
                    
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <i class="fas fa-dog" style="color: var(--primary-color);"></i>
                            <div class="stat-value" id="total-dogs">0</div>
                            <div class="stat-label">总犬只数</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-mars" style="color: var(--info-color);"></i>
                            <div class="stat-value" id="male-dogs">0</div>
                            <div class="stat-label">雄性犬</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-venus" style="color: #e83e8c;"></i>
                            <div class="stat-value" id="female-dogs">0</div>
                            <div class="stat-label">雌性犬</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-baby" style="color: var(--warning-color);"></i>
                            <div class="stat-value" id="pregnant-dogs">0</div>
                            <div class="stat-label">怀孕犬只</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-syringe" style="color: var(--success-color);"></i>
                            <div class="stat-value" id="vaccination-due">0</div>
                            <div class="stat-label">需免疫犬只</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-calendar-alt" style="color: var(--accent-color);"></i>
                            <div class="stat-value" id="upcoming-births">0</div>
                            <div class="stat-label">即将分娩</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-bell"></i> 系统提醒</h3>
                        <div id="alerts-container">
                            <!-- 提醒内容将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> 快速统计</h3>
                        <div class="button-group">
                            <button class="btn btn-primary" id="refresh-stats"><i class="fas fa-sync-alt"></i> 刷新统计</button>
                            <button class="btn btn-info" id="generate-report"><i class="fas fa-file-alt"></i> 生成详细报告</button>
                            <button class="btn btn-success" id="quick-add-dog"><i class="fas fa-plus"></i> 快速添加犬只</button>
                        </div>
                    </div>
                </div>
                
                <!-- 添加犬只 -->
                <div id="add-dog" class="content-section">
                    <h2 class="page-title"><i class="fas fa-plus-circle"></i> 添加新犬只</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-info-circle"></i> 犬只基本信息</h3>
                        <form id="add-dog-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dog-name">犬名 *</label>
                                    <input type="text" id="dog-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="dog-breed">品种 *</label>
                                    <select id="dog-breed" required>
                                        <option value="">请选择品种</option>
                                        <option value="德国牧羊犬">德国牧羊犬</option>
                                        <option value="马里努阿犬">马里努阿犬</option>
                                        <option value="罗威纳犬">罗威纳犬</option>
                                        <option value="杜宾犬">杜宾犬</option>
                                        <option value="拉布拉多犬">拉布拉多犬</option>
                                        <option value="史宾格犬">史宾格犬</option>
                                        <option value="昆明犬">昆明犬</option>
                                        <option value="太仓犬">太仓犬</option>
                                        <option value="寻血猎犬">寻血猎犬</option>
                                        <option value="东德牧犬">东德牧犬</option>
                                        <option value="波音达犬">波音达犬</option>
                                        <option value="边境牧羊犬">边境牧羊犬</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 新增：父母信息 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dog-father-name">父亲</label>
                                    <div class="parent-input-container">
                                        <input type="text" id="dog-father-name" placeholder="输入父亲犬名或ID搜索" autocomplete="off">
                                        <input type="hidden" id="dog-father-id">
                                        <button type="button" class="btn btn-sm btn-info" id="clear-father-btn" style="display: none;"><i class="fas fa-times"></i> 清除</button>
                                    </div>
                                    <div class="parent-search-results" id="father-search-results"></div>
                                    <small style="color: #666;">输入父亲犬名或ID进行搜索，或留空表示未知</small>
                                </div>
                                <div class="form-group">
                                    <label for="dog-mother-name">母亲</label>
                                    <div class="parent-input-container">
                                        <input type="text" id="dog-mother-name" placeholder="输入母亲犬名或ID搜索" autocomplete="off">
                                        <input type="hidden" id="dog-mother-id">
                                        <button type="button" class="btn btn-sm btn-info" id="clear-mother-btn" style="display: none;"><i class="fas fa-times"></i> 清除</button>
                                    </div>
                                    <div class="parent-search-results" id="mother-search-results"></div>
                                    <small style="color: #666;">输入母亲犬名或ID进行搜索，或留空表示未知</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dog-gender">性别 *</label>
                                    <select id="dog-gender" required>
                                        <option value="">请选择性别</option>
                                        <option value="male">雄性</option>
                                        <option value="female">雌性</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="dog-birthdate">出生日期 *</label>
                                    <input type="date" id="dog-birthdate" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dog-color">毛色</label>
                                    <input type="text" id="dog-color" placeholder="例如：黑背、浅黄等">
                                </div>
                                <!-- 新增：犬舍号字段 -->
                                <div class="form-group">
                                    <label for="dog-kennel">犬舍号 *</label>
                                    <input type="text" id="dog-kennel" placeholder="例如：A101、B203等" required>
                                    <small style="color: #666;">请输入犬舍编号，如A101、B203等</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dog-chip">芯片ID</label>
                                    <input type="text" id="dog-chip" placeholder="可选">
                                </div>
                                <div class="form-group">
                                    <label for="dog-origin">来源</label>
                                    <input type="text" id="dog-origin" placeholder="例如：公安部昆明基地">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dog-trainer">训导员</label>
                                    <input type="text" id="dog-trainer" placeholder="负责训导员姓名">
                                </div>
                                <div class="form-group">
                                    <label for="dog-health">健康状况</label>
                                    <select id="dog-health">
                                        <option value="健康">健康</option>
                                        <option value="良好">良好</option>
                                        <option value="一般">一般</option>
                                        <option value="需关注">需关注</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dog-status">当前状态</label>
                                    <select id="dog-status">
                                        <option value="在训">在训</option>
                                        <option value="服役">服役</option>
                                        <option value="繁殖">繁殖</option>
                                        <option value="退役">退役</option>
                                        <option value="休养">休养</option>
                                    </select>
                                </div>
                                <!-- 新增：犬舍区域 -->
                                <div class="form-group">
                                    <label for="dog-kennel-area">犬舍区域</label>
                                    <select id="dog-kennel-area">
                                        <option value="">请选择区域</option>
                                        <option value="繁殖区">繁殖区</option>
                                        <option value="训练区">训练区</option>
                                        <option value="幼犬区">幼犬区</option>
                                        <option value="隔离区">隔离区</option>
                                        <option value="医疗区">医疗区</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="dog-notes">备注</label>
                                <textarea id="dog-notes" rows="3" placeholder="其他需要记录的信息..."></textarea>
                            </div>
                            
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存犬只信息</button>
                                <button type="reset" class="btn btn-warning"><i class="fas fa-redo"></i> 重置表单</button>
                                <button type="button" class="btn btn-info" id="preview-dog"><i class="fas fa-eye"></i> 预览信息</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card" id="preview-card" style="display: none;">
                        <h3><i class="fas fa-eye"></i> 信息预览</h3>
                        <div id="dog-preview"></div>
                    </div>
                </div>
                
                <!-- 查看犬只 -->
                <div id="view-dogs" class="content-section">
                    <h2 class="page-title"><i class="fas fa-list"></i> 查看犬只</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-search"></i> 搜索与筛选</h3>
                        <div class="search-box">
                            <input type="text" id="search-dogs" placeholder="输入犬名、品种、训导员、犬舍号或芯片ID进行搜索...">
                            <!-- 新增：品种筛选 -->
                            <select id="filter-breed">
                                <option value="">所有品种</option>
                                <option value="德国牧羊犬">德国牧羊犬</option>
                                <option value="马里努阿犬">马里努阿犬</option>
                                <option value="罗威纳犬">罗威纳犬</option>
                                <option value="杜宾犬">杜宾犬</option>
                                <option value="拉布拉多犬">拉布拉多犬</option>
                                <option value="史宾格犬">史宾格犬</option>
                                <option value="昆明犬">昆明犬</option>
                                <option value="太仓犬">太仓犬</option>
                                <option value="寻血猎犬">寻血猎犬</option>
                                <option value="东德牧犬">东德牧犬</option>
                                <option value="波音达犬">波音达犬</option>
                                <option value="边境牧羊犬">边境牧羊犬</option>
                                <option value="其他">其他</option>
                            </select>
                            <select id="filter-gender">
                                <option value="">所有性别</option>
                                <option value="male">雄性</option>
                                <option value="female">雌性</option>
                            </select>
                            <select id="filter-status">
                                <option value="">所有状态</option>
                                <option value="在训">在训</option>
                                <option value="服役">服役</option>
                                <option value="繁殖">繁殖</option>
                                <option value="退役">退役</option>
                                <option value="休养">休养</option>
                            </select>
                            <!-- 新增：犬舍号筛选 -->
                            <select id="filter-kennel" class="filter-kennel">
                                <option value="">所有犬舍</option>
                                <!-- 犬舍号选项将通过JavaScript动态生成 -->
                            </select>
                            <button class="btn btn-primary" id="search-btn"><i class="fas fa-search"></i> 搜索</button>
                        </div>
                        
                        <!-- 新增：Excel导出按钮组 -->
                        <div class="excel-export-section">
                            <h4><i class="fas fa-file-excel"></i> Excel导出</h4>
                            <p>导出当前筛选条件下的犬只数据到Excel文件</p>
                            <div class="excel-export-buttons">
                                <button class="excel-export-btn" id="export-excel-current">
                                    <i class="fas fa-download"></i> 导出当前列表
                                </button>
                                <button class="excel-export-btn" id="export-excel-all">
                                    <i class="fas fa-database"></i> 导出全部犬只
                                </button>
                                <button class="excel-export-btn" id="export-excel-detailed">
                                    <i class="fas fa-file-alt"></i> 导出详细数据
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table id="dogs-table">
                                <thead>
                                    <tr>
                                        <th>犬名</th>
                                        <th>品种</th>
                                        <th>性别</th>
                                        <th>犬舍号</th>
                                        <th>年龄</th>
                                        <th>训导员</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="dogs-table-body">
                                    <!-- 犬只列表将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-success" id="export-dogs"><i class="fas fa-file-export"></i> 导出数据(JSON)</button>
                            <button class="btn btn-info" id="print-dogs"><i class="fas fa-print"></i> 打印列表</button>
                        </div>
                    </div>
                </div>
                
                <!-- 发情记录 -->
                <div id="record-heat" class="content-section">
                    <h2 class="page-title"><i class="fas fa-heartbeat"></i> 发情记录</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-plus"></i> 新增发情记录</h3>
                        <form id="add-heat-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="heat-dog-id">选择雌性犬 *</label>
                                    <select id="heat-dog-id" required>
                                        <option value="">请选择犬只</option>
                                        <!-- 雌性犬选项将通过JavaScript动态生成 -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="heat-date">发情日期 *</label>
                                    <input type="date" id="heat-date" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="heat-notes">备注</label>
                                <textarea id="heat-notes" rows="3" placeholder="记录发情周期、表现等详细信息..."></textarea>
                            </div>
                            
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存发情记录</button>
                                <button type="reset" class="btn btn-warning"><i class="fas fa-redo"></i> 重置</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-history"></i> 发情历史记录</h3>
                        <div class="table-container">
                            <table id="heat-table">
                                <thead>
                                    <tr>
                                        <th>犬名</th>
                                        <th>品种</th>
                                        <th>犬舍号</th>
                                        <th>发情日期</th>
                                        <th>记录日期</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="heat-table-body">
                                    <!-- 发情记录将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 配种记录 -->
                <div id="record-breeding" class="content-section">
                    <h2 class="page-title"><i class="fas fa-paw"></i> 配种记录</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-plus"></i> 新增配种记录</h3>
                        <form id="add-breeding-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="breeding-female-id">雌性犬 *</label>
                                    <select id="breeding-female-id" required>
                                        <option value="">请选择雌性犬</option>
                                        <!-- 雌性犬选项将通过JavaScript动态生成 -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="breeding-male-id">雄性犬 *</label>
                                    <select id="breeding-male-id" required>
                                        <option value="">请选择雄性犬</option>
                                        <!-- 雄性犬选项将通过JavaScript动态生成 -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="breeding-date">配种日期 *</label>
                                    <input type="date" id="breeding-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="breeding-expected-date">预产期</label>
                                    <input type="date" id="breeding-expected-date">
                                    <small style="color: #666;">(自动计算：配种日期+63天，可手动修改)</small>
                                </div>
                            </div>
                            
                            <!-- 新增：第一次影像检查记录 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="breeding-check1-date">第一次影像检查日期</label>
                                    <input type="date" id="breeding-check1-date">
                                </div>
                                <div class="form-group">
                                    <label for="breeding-check1-result">第一次影像检查结果</label>
                                    <select id="breeding-check1-result">
                                        <option value="">请选择检查结果</option>
                                        <option value="未怀孕">未怀孕</option>
                                        <option value="怀孕初期">怀孕初期</option>
                                        <option value="怀孕中期">怀孕中期</option>
                                        <option value="怀孕后期">怀孕后期</option>
                                        <option value="胎儿正常">胎儿正常</option>
                                        <option value="胎儿异常">胎儿异常</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 新增：第二次影像检查记录 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="breeding-check2-date">第二次影像检查日期</label>
                                    <input type="date" id="breeding-check2-date">
                                </div>
                                <div class="form-group">
                                    <label for="breeding-check2-result">第二次影像检查结果</label>
                                    <select id="breeding-check2-result">
                                        <option value="">请选择检查结果</option>
                                        <option value="未怀孕">未怀孕</option>
                                        <option value="怀孕初期">怀孕初期</option>
                                        <option value="怀孕中期">怀孕中期</option>
                                        <option value="怀孕后期">怀孕后期</option>
                                        <option value="胎儿正常">胎儿正常</option>
                                        <option value="胎儿异常">胎儿异常</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="breeding-check-notes">影像检查备注</label>
                                <textarea id="breeding-check-notes" rows="3" placeholder="记录影像检查的具体情况、胎儿数量、发育状态等..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="breeding-notes">配种备注</label>
                                <textarea id="breeding-notes" rows="3" placeholder="记录配种情况、注意事项等..."></textarea>
                            </div>
                            
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存配种记录</button>
                                <button type="button" class="btn btn-info" id="calculate-due-date"><i class="fas fa-calculator"></i> 计算预产期</button>
                                <button type="reset" class="btn btn-warning"><i class="fas fa-redo"></i> 重置</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-history"></i> 配种历史记录</h3>
                        <div class="table-container">
                            <table id="breeding-table">
                                <thead>
                                    <tr>
                                        <th>雌性犬</th>
                                        <th>犬舍号</th>
                                        <th>雄性犬</th>
                                        <th>犬舍号</th>
                                        <th>配种日期</th>
                                        <th>预产期</th>
                                        <!-- 新增：影像检查列 -->
                                        <th>第一次影像检查</th>
                                        <th>第二次影像检查</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="breeding-table-body">
                                    <!-- 配种记录将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 分娩记录 -->
                <div id="record-birth" class="content-section">
                    <h2 class="page-title"><i class="fas fa-baby"></i> 分娩记录</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-plus"></i> 新增分娩记录</h3>
                        <form id="add-birth-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="birth-female-id">雌性犬 *</label>
                                    <div class="mother-puppy-select">
                                        <select id="birth-female-id" required>
                                            <option value="">请选择雌性犬</option>
                                            <!-- 怀孕中的雌性犬选项将通过JavaScript动态生成 -->
                                        </select>
                                        <button type="button" class="btn btn-info" id="quick-add-mother-btn"><i class="fas fa-plus"></i> 快速添加</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="birth-breeding-id">配种记录</label>
                                    <select id="birth-breeding-id">
                                        <option value="">请选择配种记录</option>
                                        <!-- 配种记录选项将通过JavaScript动态生成 -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="birth-date">分娩日期 *</label>
                                    <input type="date" id="birth-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="birth-puppy-count">幼犬数量 *</label>
                                    <input type="number" id="birth-puppy-count" min="1" max="20" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="birth-notes">分娩备注</label>
                                <textarea id="birth-notes" rows="3" placeholder="记录分娩过程、特殊情况等..."></textarea>
                            </div>
                            
                            <!-- 新增：幼犬预约驱虫和免疫 -->
                            <div class="puppy-schedule-card">
                                <h5><i class="fas fa-calendar-check"></i> 幼犬健康管理预约</h5>
                                <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">为新生幼犬设置驱虫和免疫预约日期，系统会自动提醒</p>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="puppy-deworm-date">首次驱虫预约日期</label>
                                        <input type="date" id="puppy-deworm-date">
                                        <small style="color: #666;">建议出生后2-3周进行首次驱虫</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="puppy-vaccine-date">首次免疫预约日期</label>
                                        <input type="date" id="puppy-vaccine-date">
                                        <small style="color: #666;">建议出生后6-8周进行首次免疫</small>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="puppy-schedule-notes">幼犬健康备注</label>
                                    <textarea id="puppy-schedule-notes" rows="2" placeholder="记录幼犬健康状况、特殊注意事项等..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-group" id="puppy-details-container">
                                <label>幼犬详细信息 <button type="button" class="btn btn-sm btn-info" id="add-puppy-detail"><i class="fas fa-plus"></i> 添加幼犬</button></label>
                                <div id="puppy-details-list">
                                    <!-- 幼犬详细信息将通过JavaScript动态添加 -->
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存分娩记录</button>
                                <button type="reset" class="btn btn-warning"><i class="fas fa-redo"></i> 重置</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-history"></i> 分娩历史记录</h3>
                        <div class="table-container">
                            <table id="birth-table">
                                <thead>
                                    <tr>
                                        <th>雌性犬</th>
                                        <th>犬舍号</th>
                                        <th>分娩日期</th>
                                        <th>幼犬数量</th>
                                        <th>驱虫预约</th>
                                        <th>免疫预约</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="birth-table-body">
                                    <!-- 分娩记录将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 免疫记录 -->
                <div id="record-vaccination" class="content-section">
                    <h2 class="page-title"><i class="fas fa-syringe"></i> 免疫记录</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-plus"></i> 新增免疫记录</h3>
                        <form id="add-vaccination-form">
                            <!-- 新增：通过母犬关联幼犬 -->
                            <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);">
                                <h4><i class="fas fa-link"></i> 通过母犬关联幼犬</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="mother-dog-select">选择母犬</label>
                                        <select id="mother-dog-select">
                                            <option value="">请选择母犬</option>
                                            <!-- 雌性犬选项将通过JavaScript动态生成 -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="mother-birth-select">选择分娩记录</label>
                                        <select id="mother-birth-select">
                                            <option value="">请先选择母犬</option>
                                            <!-- 分娩记录选项将通过JavaScript动态生成 -->
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="puppy-selection-container" style="display: none;">
                                    <label>选择幼犬进行免疫</label>
                                    <div class="puppy-list-container" id="puppy-list">
                                        <!-- 幼犬列表将通过JavaScript动态生成 -->
                                    </div>
                                    <small style="color: #666;">勾选需要记录免疫的幼犬，可多选</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="vaccination-dog-id">选择犬只 *</label>
                                    <select id="vaccination-dog-id" required>
                                        <option value="">请选择犬只</option>
                                        <!-- 所有犬只选项将通过JavaScript动态生成 -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="vaccination-type">疫苗类型 *</label>
                                    <select id="vaccination-type" required>
                                        <option value="">请选择疫苗类型</option>
                                        <option value="狂犬疫苗">狂犬疫苗</option>
                                        <option value="五联疫苗">五联疫苗</option>
                                        <option value="六联疫苗">六联疫苗</option>
                                        <option value="八联疫苗">八联疫苗</option>
                                        <option value="犬瘟热疫苗">犬瘟热疫苗</option>
                                        <option value="细小病毒疫苗">细小病毒疫苗</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 新增：手动输入疫苗类型的容器 -->
                            <div class="custom-vaccine-container" id="custom-vaccine-container">
                                <div class="form-group">
                                    <label for="custom-vaccine-name">请输入疫苗类型名称 *</label>
                                    <input type="text" id="custom-vaccine-name" placeholder="请输入具体的疫苗类型，例如：冠状病毒疫苗、钩端螺旋体疫苗等">
                                </div>
                                
                                <!-- 新增：疫苗类型快速选择按钮 -->
                                <div class="vaccine-quick-select" id="vaccine-quick-select">
                                    <!-- 快速选择按钮将通过JavaScript动态生成 -->
                                </div>
                                
                                <!-- 新增：疫苗类型历史记录 -->
                                <div class="vaccine-history-list" id="vaccine-history-list">
                                    <h5 style="margin-bottom: 10px;">常用疫苗类型</h5>
                                    <!-- 疫苗历史记录将通过JavaScript动态生成 -->
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="vaccination-date">免疫日期 *</label>
                                    <input type="date" id="vaccination-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="next-vaccination-date">下次免疫日期</label>
                                    <input type="date" id="next-vaccination-date">
                                    <small style="color: #666;">(自动计算，可手动修改)</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="vaccination-notes">备注</label>
                                <textarea id="vaccination-notes" rows="3" placeholder="记录疫苗批号、注射部位、反应等..."></textarea>
                            </div>
                            
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存免疫记录</button>
                                <button type="button" class="btn btn-info" id="calculate-next-vaccination"><i class="fas fa-calculator"></i> 计算下次日期</button>
                                <button type="reset" class="btn btn-warning"><i class="fas fa-redo"></i> 重置</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-history"></i> 免疫历史记录</h3>
                        <div class="table-container">
                            <table id="vaccination-table">
                                <thead>
                                    <tr>
                                        <th>犬名</th>
                                        <th>犬舍号</th>
                                        <th>疫苗类型</th>
                                        <th>免疫日期</th>
                                        <th>下次免疫</th>
                                        <th>剩余天数</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="vaccination-table-body">
                                    <!-- 免疫记录将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-bell"></i> 免疫提醒</h3>
                        <div id="vaccination-alerts">
                            <!-- 免疫提醒将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 统计报告 -->
                <div id="reports" class="content-section">
                    <h2 class="page-title"><i class="fas fa-chart-bar"></i> 统计报告</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-chart-pie"></i> 犬只统计</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="report-type">报告类型</label>
                                <select id="report-type">
                                    <option value="summary">概览报告</option>
                                    <option value="breed">品种分布</option>
                                    <option value="breeding">繁殖统计</option>
                                    <option value="vaccination">免疫统计</option>
                                    <option value="health">健康统计</option>
                                    <option value="kennel">犬舍分布</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="report-period">统计周期</label>
                                <select id="report-period">
                                    <option value="all">全部时间</option>
                                    <option value="year">本年</option>
                                    <option value="quarter">本季度</option>
                                    <option value="month">本月</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-primary" id="generate-stat-report"><i class="fas fa-chart-bar"></i> 生成统计报告</button>
                            <button class="btn btn-success" id="export-report-excel"><i class="fas fa-file-excel"></i> 导出为Excel</button>
                            <button class="btn btn-info" id="print-report"><i class="fas fa-print"></i> 打印报告</button>
                        </div>
                        
                        <div id="report-results" style="margin-top: 25px;">
                            <!-- 报告结果将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-calendar-alt"></i> 近期事件</h3>
                        <div id="upcoming-events">
                            <!-- 近期事件将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 数据管理 -->
                <div id="data-management" class="content-section">
                    <h2 class="page-title"><i class="fas fa-database"></i> 数据管理</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-download"></i> 数据备份</h3>
                        <p>系统数据存储在您的浏览器本地，定期备份可防止数据丢失。</p>
                        <div class="button-group">
                            <button class="btn btn-primary" id="backup-data"><i class="fas fa-save"></i> 备份当前数据</button>
                            <button class="btn btn-success" id="export-json"><i class="fas fa-file-export"></i> 导出JSON文件</button>
                            <button class="btn btn-warning" id="auto-backup-toggle"><i class="fas fa-robot"></i> 自动备份: 关闭</button>
                        </div>
                        
                        <!-- 新增：Excel导出选项 -->
                        <div class="excel-export-section">
                            <h4><i class="fas fa-file-excel"></i> Excel数据导出</h4>
                            <p>导出系统数据到Excel文件，方便数据分析和共享</p>
                            <div class="excel-export-buttons">
                                <button class="excel-export-btn" id="export-excel-complete">
                                    <i class="fas fa-file-excel"></i> 导出完整数据
                                </button>
                                <button class="excel-export-btn" id="export-excel-breeds">
                                    <i class="fas fa-paw"></i> 导出品种统计
                                </button>
                                <button class="excel-export-btn" id="export-excel-vaccinations">
                                    <i class="fas fa-syringe"></i> 导出免疫记录
                                </button>
                                <button class="excel-export-btn" id="export-excel-breeding">
                                    <i class="fas fa-baby"></i> 导出繁殖记录
                                </button>
                                <button class="excel-export-btn" id="export-excel-kennel">
                                    <i class="fas fa-home"></i> 导出犬舍分布
                                </button>
                            </div>
                        </div>
                        
                        <div id="backup-list" style="margin-top: 20px;">
                            <!-- 备份列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-upload"></i> 数据恢复</h3>
                        <p>从备份文件或JSON文件恢复系统数据。</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="backup-file">选择备份文件</label>
                                <input type="file" id="backup-file" accept=".json">
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-info" id="restore-backup"><i class="fas fa-undo"></i> 恢复备份</button>
                            <button class="btn btn-danger" id="clear-data"><i class="fas fa-trash-alt"></i> 清空所有数据</button>
                        </div>
                        <div class="alert alert-warning" style="margin-top: 20px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>警告：</strong> 恢复备份或清空数据将覆盖当前所有数据，请谨慎操作！
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-cog"></i> 系统设置</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="system-theme">界面主题</label>
                                <select id="system-theme">
                                    <option value="light">浅色主题</option>
                                    <option value="dark">深色主题</option>
                                    <option value="blue">蓝色主题</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="reminder-days">提前提醒天数</label>
                                <input type="number" id="reminder-days" min="1" max="90" value="30">
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" id="save-settings"><i class="fas fa-save"></i> 保存设置</button>
                            <button class="btn btn-warning" id="reset-settings"><i class="fas fa-redo"></i> 恢复默认</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>警犬繁育管理系统 &copy; 2023 | 公安部警犬技术基地 | 技术支持电话: 400-123-4567</p>
            <p>数据安全提示：请定期备份数据，系统数据仅存储在您的浏览器本地。</p>
        </footer>
    </div>
    
    <!-- 犬只详情模态框 -->
    <div class="modal" id="dog-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-dog"></i> 犬只详细信息</h3>
                <button class="modal-close" id="close-dog-detail">&times;</button>
            </div>
            <div class="modal-body" id="dog-detail-content">
                <!-- 犬只详情将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 确认操作模态框 -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-question-circle"></i> 确认操作</h3>
                <button class="modal-close" id="close-confirm">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message">您确定要执行此操作吗？</p>
                <div class="button-group" style="justify-content: flex-end;">
                    <button class="btn btn-secondary" id="confirm-cancel">取消</button>
                    <button class="btn btn-danger" id="confirm-ok">确定</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 快速添加雌性犬模态框 -->
    <div class="modal" id="quick-add-mother-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> 快速添加雌性犬</h3>
                <button class="modal-close" id="close-quick-add-mother">&times;</button>
            </div>
            <div class="modal-body">
                <form id="quick-add-mother-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quick-mother-name">犬名 *</label>
                            <input type="text" id="quick-mother-name" required placeholder="请输入犬名">
                        </div>
                        <div class="form-group">
                            <label for="quick-mother-breed">品种 *</label>
                            <select id="quick-mother-breed" required>
                                <option value="">请选择品种</option>
                                <option value="德国牧羊犬">德国牧羊犬</option>
                                <option value="马里努阿犬">马里努阿犬</option>
                                <option value="罗威纳犬">罗威纳犬</option>
                                <option value="杜宾犬">杜宾犬</option>
                                <option value="拉布拉多犬">拉布拉多犬</option>
                                <option value="史宾格犬">史宾格犬</option>
                                <option value="昆明犬">昆明犬</option>
                                <option value="太仓犬">太仓犬</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quick-mother-birthdate">出生日期 *</label>
                            <input type="date" id="quick-mother-birthdate" required>
                        </div>
                        <div class="form-group">
                            <label for="quick-mother-color">毛色</label>
                            <input type="text" id="quick-mother-color" placeholder="例如：黑背、浅黄等">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quick-mother-kennel">犬舍号 *</label>
                            <input type="text" id="quick-mother-kennel" required placeholder="例如：A101、B203等">
                        </div>
                        <div class="form-group">
                            <label for="quick-mother-status">当前状态</label>
                            <select id="quick-mother-status">
                                <option value="繁殖">繁殖</option>
                                <option value="服役">服役</option>
                                <option value="在训">在训</option>
                                <option value="休养">休养</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存并选择</button>
                        <button type="button" class="btn btn-secondary" id="cancel-quick-add-mother">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // 警犬繁育管理系统核心逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 系统状态和数据
            const system = {
                dogs: {},
                heatRecords: [],
                breedingRecords: [],
                birthRecords: [],
                vaccinationRecords: [],
                dewormingRecords: [], // 新增：驱虫记录
                puppySchedules: [],   // 新增：幼犬预约记录
                settings: {
                    theme: 'light',
                    reminderDays: 30,
                    autoBackup: false
                },
                version: '1.0.1' // 版本更新
            };
            
            // 新增：疫苗类型管理
            const vaccineManager = {
                // 预定义疫苗类型
                predefinedVaccines: [
                    '狂犬疫苗',
                    '五联疫苗',
                    '六联疫苗',
                    '八联疫苗',
                    '犬瘟热疫苗',
                    '细小病毒疫苗',
                    '冠状病毒疫苗',
                    '钩端螺旋体疫苗',
                    '副流感疫苗',
                    '支气管炎疫苗'
                ],
                
                // 获取所有使用过的疫苗类型
                getUsedVaccineTypes: function() {
                    const usedTypes = {};
                    
                    // 从现有记录中统计疫苗类型
                    system.vaccinationRecords.forEach(record => {
                        if (record.type) {
                            usedTypes[record.type] = (usedTypes[record.type] || 0) + 1;
                        }
                    });
                    
                    return usedTypes;
                },
                
                // 获取疫苗类型列表（去重）
                getVaccineTypeList: function() {
                    const usedTypes = this.getUsedVaccineTypes();
                    const typeList = [...this.predefinedVaccines];
                    
                    // 添加使用过的自定义类型
                    Object.keys(usedTypes).forEach(type => {
                        if (!typeList.includes(type)) {
                            typeList.push(type);
                        }
                    });
                    
                    return typeList.sort();
                },
                
                // 判断是否为自定义疫苗类型
                isCustomVaccineType: function(vaccineType) {
                    return !this.predefinedVaccines.includes(vaccineType);
                }
            };
            
            // 初始化系统
            function initSystem() {
                loadData();
                loadSettings();
                updateDashboard();
                populateDogSelects();
                renderDogList();
                renderHeatRecords();
                renderBreedingRecords();
                renderBirthRecords();
                renderVaccinationRecords();
                setupEventListeners();
                setupParentSearch();
                
                // 显示欢迎消息
                showAlert('欢迎使用警犬繁育管理系统！系统已就绪。', 'success');
            }
            
            // 加载数据
            function loadData() {
                const savedData = localStorage.getItem('dogBreedingSystem');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        Object.assign(system, data);
                        console.log('数据加载成功');
                    } catch (e) {
                        console.error('数据加载失败:', e);
                        // 加载示例数据
                        loadSampleData();
                    }
                } else {
                    // 加载示例数据
                    loadSampleData();
                }
            }
            
            // 加载示例数据
            function loadSampleData() {
                // 示例犬只数据（增加父亲母亲字段和犬舍号字段）
                system.dogs = {
                    'DOG-001': {
                        id: 'DOG-001',
                        name: '黑虎',
                        breed: '德国牧羊犬',
                        gender: 'male',
                        birthDate: '2021-05-10',
                        color: '黑背',
                        chipId: 'CHIP-001',
                        kennel: 'A101', // 新增：犬舍号
                        kennelArea: '训练区', // 新增：犬舍区域
                        origin: '公安部昆明基地',
                        trainer: '张三',
                        health: '健康',
                        status: '服役',
                        notes: '优秀搜索犬',
                        fatherId: null,
                        fatherName: '',
                        motherId: null,
                        motherName: '',
                        createdDate: '2023-01-15',
                        updatedDate: '2023-11-27'
                    },
                    'DOG-002': {
                        id: 'DOG-002',
                        name: '玫瑰',
                        breed: '马里努阿犬',
                        gender: 'female',
                        birthDate: '2020-08-15',
                        color: '浅黄',
                        chipId: 'CHIP-002',
                        kennel: 'B202', // 新增：犬舍号
                        kennelArea: '繁殖区', // 新增：犬舍区域
                        origin: '沈阳基地',
                        trainer: '李四',
                        health: '健康',
                        status: '繁殖',
                        notes: '繁殖母犬',
                        fatherId: null,
                        fatherName: '',
                        motherId: null,
                        motherName: '',
                        createdDate: '2023-01-15',
                        updatedDate: '2023-11-27'
                    },
                    'DOG-003': {
                        id: 'DOG-003',
                        name: '雷霆',
                        breed: '罗威纳犬',
                        gender: 'male',
                        birthDate: '2022-03-15',
                        color: '黑色',
                        chipId: 'CHIP-003',
                        kennel: 'A102', // 新增：犬舍号
                        kennelArea: '训练区', // 新增：犬舍区域
                        origin: '北京基地',
                        trainer: '王五',
                        health: '健康',
                        status: '在训',
                        notes: '护卫犬',
                        fatherId: 'DOG-001',
                        fatherName: '黑虎',
                        motherId: 'DOG-002',
                        motherName: '玫瑰',
                        createdDate: '2023-03-20',
                        updatedDate: '2023-11-27'
                    },
                    'DOG-004': {
                        id: 'DOG-004',
                        name: '风暴',
                        breed: '德国牧羊犬',
                        gender: 'male',
                        birthDate: '2019-11-20',
                        color: '狼灰色',
                        chipId: 'CHIP-004',
                        kennel: 'C301', // 新增：犬舍号
                        kennelArea: '医疗区', // 新增：犬舍区域
                        origin: '公安部昆明基地',
                        trainer: '赵六',
                        health: '健康',
                        status: '服役',
                        notes: '优秀追踪犬',
                        fatherId: null,
                        fatherName: '猎鹰',
                        motherId: null,
                        motherName: '小花',
                        createdDate: '2023-04-10',
                        updatedDate: '2023-11-27'
                    }
                };
                
                // 示例发情记录
                system.heatRecords = [
                    {
                        id: 'HEAT-001',
                        dogId: 'DOG-002',
                        date: '2023-10-01',
                        recordedDate: '2023-10-01',
                        notes: '首次发情，持续约15天'
                    }
                ];
                
                // 示例配种记录（增加影像检查字段）
                system.breedingRecords = [
                    {
                        id: 'BREED-001',
                        femaleId: 'DOG-002',
                        maleId: 'DOG-001',
                        date: '2023-10-03',
                        expectedDate: '2023-12-05',
                        check1Date: '2023-10-15',
                        check1Result: '怀孕初期',
                        check2Date: '2023-11-10',
                        check2Result: '怀孕中期，胎儿发育良好',
                        checkNotes: 'B超检查显示胎儿正常',
                        actualDate: null,
                        status: 'pregnant',
                        notes: '首次配种，情况良好',
                        recordedDate: '2023-10-03'
                    }
                ];
                
                // 示例免疫记录
                system.vaccinationRecords = [
                    {
                        id: 'VACC-001',
                        dogId: 'DOG-001',
                        type: '狂犬疫苗',
                        date: '2023-12-10',
                        nextDate: '2024-12-10',
                        notes: '年度免疫，无不良反应',
                        recordedDate: '2023-12-10'
                    },
                    {
                        id: 'VACC-002',
                        dogId: 'DOG-002',
                        type: '五联疫苗',
                        date: '2023-11-15',
                        nextDate: '2024-02-15',
                        notes: '常规免疫',
                        recordedDate: '2023-11-15'
                    },
                    {
                        id: 'VACC-003',
                        dogId: 'DOG-003',
                        type: '钩端螺旋体疫苗',
                        date: '2023-11-20',
                        nextDate: '2024-05-20',
                        notes: '地区特定疫苗',
                        recordedDate: '2023-11-20'
                    }
                ];
                
                // 新增：示例驱虫记录
                system.dewormingRecords = [
                    {
                        id: 'DEWORM-001',
                        dogId: 'DOG-001',
                        date: '2023-11-01',
                        nextDate: '2024-02-01',
                        notes: '常规驱虫',
                        recordedDate: '2023-11-01'
                    }
                ];
                
                // 新增：示例幼犬预约记录
                system.puppySchedules = [
                    {
                        id: 'SCHEDULE-001',
                        birthRecordId: 'BIRTH-001',
                        motherId: 'DOG-002',
                        dewormDate: '2023-12-20',
                        vaccineDate: '2024-01-15',
                        notes: '幼犬首次健康管理',
                        recordedDate: '2023-12-05'
                    }
                ];
                
                console.log('示例数据加载成功');
            }
            
            // 保存数据
            function saveData() {
                try {
                    localStorage.setItem('dogBreedingSystem', JSON.stringify(system));
                    console.log('数据保存成功');
                    
                    // 如果有自动备份设置，执行备份
                    if (system.settings.autoBackup) {
                        createBackup();
                    }
                    
                    return true;
                } catch (e) {
                    console.error('数据保存失败:', e);
                    showAlert('数据保存失败，请检查存储空间！', 'danger');
                    return false;
                }
            }
            
            // 加载设置
            function loadSettings() {
                const savedSettings = localStorage.getItem('dogBreedingSettings');
                if (savedSettings) {
                    try {
                        system.settings = JSON.parse(savedSettings);
                        applySettings();
                    } catch (e) {
                        console.error('设置加载失败:', e);
                    }
                }
            }
            
            // 保存设置
            function saveSettings() {
                localStorage.setItem('dogBreedingSettings', JSON.stringify(system.settings));
                applySettings();
                showAlert('设置保存成功！', 'success');
            }
            
            // 应用设置
            function applySettings() {
                // 应用主题
                document.body.setAttribute('data-theme', system.settings.theme);
                
                // 更新自动备份按钮文本
                const autoBackupBtn = document.getElementById('auto-backup-toggle');
                if (autoBackupBtn) {
                    autoBackupBtn.innerHTML = `<i class="fas fa-robot"></i> 自动备份: ${system.settings.autoBackup ? '开启' : '关闭'}`;
                }
                
                // 更新提醒天数输入框
                const reminderDaysInput = document.getElementById('reminder-days');
                if (reminderDaysInput) {
                    reminderDaysInput.value = system.settings.reminderDays;
                }
                
                // 更新主题选择框
                const themeSelect = document.getElementById('system-theme');
                if (themeSelect) {
                    themeSelect.value = system.settings.theme;
                }
            }
            
            // 生成唯一ID
            function generateId(prefix) {
                const timestamp = Date.now().toString(36);
                const randomStr = Math.random().toString(36).substr(2, 5);
                return `${prefix}-${timestamp}-${randomStr}`.toUpperCase();
            }
            
            // 计算年龄
            function calculateAge(birthDate) {
                const birth = new Date(birthDate);
                const now = new Date();
                let years = now.getFullYear() - birth.getFullYear();
                let months = now.getMonth() - birth.getMonth();
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                if (years > 0) {
                    return `${years}岁${months > 0 ? `${months}个月` : ''}`;
                } else {
                    return `${months}个月`;
                }
            }
            
            // 计算预产期（配种日期+63天）
            function calculateDueDate(breedingDate) {
                const date = new Date(breedingDate);
                date.setDate(date.getDate() + 63);
                return date.toISOString().split('T')[0];
            }
            
            // 计算下次免疫日期
            function calculateNextVaccinationDate(vaccineDate, vaccineType) {
                const date = new Date(vaccineDate);
                if (vaccineType.includes('狂犬')) {
                    date.setFullYear(date.getFullYear() + 1);
                } else {
                    date.setMonth(date.getMonth() + 6);
                }
                return date.toISOString().split('T')[0];
            }
            
            // 计算下次驱虫日期
            function calculateNextDewormDate(dewormDate) {
                const date = new Date(dewormDate);
                date.setMonth(date.getMonth() + 3); // 默认3个月后
                return date.toISOString().split('T')[0];
            }
            
            // 更新仪表盘
            function updateDashboard() {
                const totalDogs = Object.keys(system.dogs).length;
                const maleDogs = Object.values(system.dogs).filter(dog => dog.gender === 'male').length;
                const femaleDogs = Object.values(system.dogs).filter(dog => dog.gender === 'female').length;
                
                // 怀孕犬只
                const pregnantDogs = system.breedingRecords.filter(record => 
                    record.status === 'pregnant' && system.dogs[record.femaleId]
                ).length;
                
                // 需要免疫的犬只（30天内）
                const today = new Date();
                const dueDate = new Date();
                dueDate.setDate(today.getDate() + system.settings.reminderDays);
                
                const vaccinationDue = system.vaccinationRecords.filter(record => {
                    if (!record.nextDate) return false;
                    const nextDate = new Date(record.nextDate);
                    return nextDate >= today && nextDate <= dueDate;
                }).length;
                
                // 即将分娩（7天内）
                const upcomingBirths = system.breedingRecords.filter(record => {
                    if (record.status !== 'pregnant' || !record.expectedDate) return false;
                    const expectedDate = new Date(record.expectedDate);
                    const daysDiff = Math.floor((expectedDate - today) / (1000 * 60 * 60 * 24));
                    return daysDiff >= 0 && daysDiff <= 7;
                }).length;
                
                // 更新统计卡片
                document.getElementById('total-dogs').textContent = totalDogs;
                document.getElementById('male-dogs').textContent = maleDogs;
                document.getElementById('female-dogs').textContent = femaleDogs;
                document.getElementById('pregnant-dogs').textContent = pregnantDogs;
                document.getElementById('vaccination-due').textContent = vaccinationDue;
                document.getElementById('upcoming-births').textContent = upcomingBirths;
                
                // 更新提醒
                updateAlerts();
            }
            
            // 更新提醒
            function updateAlerts() {
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '';
                
                const today = new Date();
                const dueDate = new Date();
                dueDate.setDate(today.getDate() + system.settings.reminderDays);
                
                let hasAlerts = false;
                
                // 检查怀孕犬只预产期提醒
                system.breedingRecords.forEach(record => {
                    if (record.status === 'pregnant' && record.expectedDate) {
                        const expectedDate = new Date(record.expectedDate);
                        const daysDiff = Math.floor((expectedDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff <= 7) {
                            const dog = system.dogs[record.femaleId];
                            const alert = createAlertElement(
                                `犬只 "${dog?.name || '未知'}"（犬舍号：${dog?.kennel || '未知'}）预计 ${daysDiff === 0 ? '今天' : `${daysDiff}天后`} 分娩，请做好准备！`,
                                daysDiff <= 3 ? 'danger' : 'warning'
                            );
                            alertsContainer.appendChild(alert);
                            hasAlerts = true;
                        }
                    }
                });
                
                // 检查免疫提醒
                system.vaccinationRecords.forEach(record => {
                    if (record.nextDate) {
                        const nextDate = new Date(record.nextDate);
                        const daysDiff = Math.floor((nextDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff <= system.settings.reminderDays) {
                            const dog = system.dogs[record.dogId];
                            const alert = createAlertElement(
                                `犬只 "${dog?.name || '未知'}"（犬舍号：${dog?.kennel || '未知'}）的 ${record.type} ${daysDiff === 0 ? '今天' : `${daysDiff}天后`} 到期，请安排免疫！`,
                                daysDiff <= 7 ? 'danger' : 'warning'
                            );
                            alertsContainer.appendChild(alert);
                            hasAlerts = true;
                        }
                    }
                });
                
                // 检查驱虫提醒
                system.dewormingRecords.forEach(record => {
                    if (record.nextDate) {
                        const nextDate = new Date(record.nextDate);
                        const daysDiff = Math.floor((nextDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff <= system.settings.reminderDays) {
                            const dog = system.dogs[record.dogId];
                            const alert = createAlertElement(
                                `犬只 "${dog?.name || '未知'}"（犬舍号：${dog?.kennel || '未知'}）的驱虫 ${daysDiff === 0 ? '今天' : `${daysDiff}天后`} 到期，请安排驱虫！`,
                                daysDiff <= 7 ? 'danger' : 'warning'
                            );
                            alertsContainer.appendChild(alert);
                            hasAlerts = true;
                        }
                    }
                });
                
                // 检查幼犬预约提醒
                system.puppySchedules.forEach(schedule => {
                    // 检查驱虫预约
                    if (schedule.dewormDate) {
                        const dewormDate = new Date(schedule.dewormDate);
                        const daysDiff = Math.floor((dewormDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff <= system.settings.reminderDays) {
                            const mother = system.dogs[schedule.motherId];
                            const alert = createAlertElement(
                                `母犬 "${mother?.name || '未知'}"（犬舍号：${mother?.kennel || '未知'}）的幼犬 ${daysDiff === 0 ? '今天' : `${daysDiff}天后`} 需要首次驱虫！`,
                                daysDiff <= 3 ? 'danger' : 'warning'
                            );
                            alertsContainer.appendChild(alert);
                            hasAlerts = true;
                        }
                    }
                    
                    // 检查免疫预约
                    if (schedule.vaccineDate) {
                        const vaccineDate = new Date(schedule.vaccineDate);
                        const daysDiff = Math.floor((vaccineDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff <= system.settings.reminderDays) {
                            const mother = system.dogs[schedule.motherId];
                            const alert = createAlertElement(
                                `母犬 "${mother?.name || '未知'}"（犬舍号：${mother?.kennel || '未知'}）的幼犬 ${daysDiff === 0 ? '今天' : `${daysDiff}天后`} 需要首次免疫！`,
                                daysDiff <= 3 ? 'danger' : 'warning'
                            );
                            alertsContainer.appendChild(alert);
                            hasAlerts = true;
                        }
                    }
                });
                
                // 如果没有提醒
                if (!hasAlerts) {
                    const alert = createAlertElement('当前没有需要立即处理的提醒。', 'success');
                    alertsContainer.appendChild(alert);
                }
            }
            
            // 创建提醒元素
            function createAlertElement(message, type) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                
                let icon = 'info-circle';
                if (type === 'danger') icon = 'exclamation-triangle';
                if (type === 'warning') icon = 'exclamation-circle';
                if (type === 'success') icon = 'check-circle';
                
                alert.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <div>${message}</div>
                `;
                
                return alert;
            }
            
            // 设置父母搜索功能
            function setupParentSearch() {
                const fatherInput = document.getElementById('dog-father-name');
                const motherInput = document.getElementById('dog-mother-name');
                const fatherResults = document.getElementById('father-search-results');
                const motherResults = document.getElementById('mother-search-results');
                const clearFatherBtn = document.getElementById('clear-father-btn');
                const clearMotherBtn = document.getElementById('clear-mother-btn');
                
                if (!fatherInput || !motherInput) return;
                
                // 搜索犬只函数
                function searchDogs(query, gender = null) {
                    if (!query) return [];
                    
                    const searchTerm = query.toLowerCase();
                    const results = [];
                    
                    Object.values(system.dogs).forEach(dog => {
                        // 如果指定了性别，则只搜索该性别的犬只
                        if (gender && dog.gender !== gender) return;
                        
                        // 搜索犬名、ID、芯片ID或犬舍号
                        if (dog.name.toLowerCase().includes(searchTerm) || 
                            dog.id.toLowerCase().includes(searchTerm) ||
                            (dog.chipId && dog.chipId.toLowerCase().includes(searchTerm)) ||
                            (dog.kennel && dog.kennel.toLowerCase().includes(searchTerm))) {
                            results.push(dog);
                        }
                    });
                    
                    return results;
                }
                
                // 显示搜索结果
                function showSearchResults(results, container, input, hiddenInput, clearBtn, isFather = true) {
                    container.innerHTML = '';
                    
                    if (results.length === 0) {
                        const noResult = document.createElement('div');
                        noResult.className = 'parent-search-item';
                        noResult.textContent = '未找到匹配的犬只';
                        container.appendChild(noResult);
                    } else {
                        results.forEach(dog => {
                            const item = document.createElement('div');
                            item.className = 'parent-search-item';
                            item.innerHTML = `
                                <div>
                                    <strong>${dog.name}</strong>
                                    <span class="parent-search-id">${dog.id} | ${dog.breed} | ${dog.gender === 'male' ? '雄' : '雌'} | 犬舍: ${dog.kennel || '未分配'}</span>
                                </div>
                            `;
                            
                            item.addEventListener('click', function() {
                                input.value = dog.name;
                                hiddenInput.value = dog.id;
                                container.style.display = 'none';
                                clearBtn.style.display = 'inline-block';
                            });
                            
                            container.appendChild(item);
                        });
                    }
                    
                    container.style.display = 'block';
                }
                
                // 父亲搜索
                fatherInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    
                    if (query) {
                        // 只搜索雄性犬
                        const results = searchDogs(query, 'male');
                        showSearchResults(results, fatherResults, fatherInput, document.getElementById('dog-father-id'), clearFatherBtn, true);
                    } else {
                        fatherResults.style.display = 'none';
                        document.getElementById('dog-father-id').value = '';
                        clearFatherBtn.style.display = 'none';
                    }
                });
                
                // 母亲搜索
                motherInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    
                    if (query) {
                        // 只搜索雌性犬
                        const results = searchDogs(query, 'female');
                        showSearchResults(results, motherResults, motherInput, document.getElementById('dog-mother-id'), clearMotherBtn, false);
                    } else {
                        motherResults.style.display = 'none';
                        document.getElementById('dog-mother-id').value = '';
                        clearMotherBtn.style.display = 'none';
                    }
                });
                
                // 清除父亲按钮
                clearFatherBtn.addEventListener('click', function() {
                    fatherInput.value = '';
                    document.getElementById('dog-father-id').value = '';
                    this.style.display = 'none';
                });
                
                // 清除母亲按钮
                clearMotherBtn.addEventListener('click', function() {
                    motherInput.value = '';
                    document.getElementById('dog-mother-id').value = '';
                    this.style.display = 'none';
                });
                
                // 点击外部关闭搜索结果
                document.addEventListener('click', function(e) {
                    if (!fatherInput.contains(e.target) && !fatherResults.contains(e.target)) {
                        fatherResults.style.display = 'none';
                    }
                    if (!motherInput.contains(e.target) && !motherResults.contains(e.target)) {
                        motherResults.style.display = 'none';
                    }
                });
            }
            
            // 填充犬只选择框
            function populateDogSelects() {
                // 获取所有需要填充的选择框
                const selectors = [
                    'heat-dog-id',
                    'breeding-female-id',
                    'breeding-male-id',
                    'birth-female-id',
                    'vaccination-dog-id',
                    'mother-dog-select' // 新增：母犬选择
                ];
                
                selectors.forEach(selector => {
                    const select = document.getElementById(selector);
                    if (!select) return;
                    
                    // 保存当前选中的值
                    const currentValue = select.value;
                    
                    // 清空选项（保留第一个提示选项）
                    select.innerHTML = select.querySelector('option[value=""]') ? 
                        '<option value="">请选择犬只</option>' : 
                        '<option value="">请选择犬只</option>';
                    
                    // 根据选择框类型过滤犬只
                    Object.values(system.dogs).forEach(dog => {
                        let shouldInclude = true;
                        
                        // 发情记录只显示雌性犬
                        if (selector === 'heat-dog-id' && dog.gender !== 'female') {
                            shouldInclude = false;
                        }
                        
                        // 配种雌性犬只显示雌性犬
                        if (selector === 'breeding-female-id' && dog.gender !== 'female') {
                            shouldInclude = false;
                        }
                        
                        // 配种雄性犬只显示雄性犬
                        if (selector === 'breeding-male-id' && dog.gender !== 'male') {
                            shouldInclude = false;
                        }
                        
                        // 分娩记录只显示雌性犬
                        if (selector === 'birth-female-id' && dog.gender !== 'female') {
                            shouldInclude = false;
                        }
                        
                        // 母犬选择只显示雌性犬
                        if (selector === 'mother-dog-select' && dog.gender !== 'female') {
                            shouldInclude = false;
                        }
                        
                        if (shouldInclude) {
                            const option = document.createElement('option');
                            option.value = dog.id;
                            option.textContent = `${dog.name} (${dog.breed}, ${dog.gender === 'male' ? '雄' : '雌'}, 犬舍: ${dog.kennel || '未分配'})`;
                            select.appendChild(option);
                        }
                    });
                    
                    // 恢复之前选中的值
                    if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                });
                
                // 填充分娩记录的配种记录选择框
                const birthBreedingSelect = document.getElementById('birth-breeding-id');
                if (birthBreedingSelect) {
                    const currentValue = birthBreedingSelect.value;
                    birthBreedingSelect.innerHTML = '<option value="">请选择配种记录</option>';
                    
                    system.breedingRecords.forEach(record => {
                        if (record.status === 'pregnant') {
                            const femaleDog = system.dogs[record.femaleId];
                            const maleDog = system.dogs[record.maleId];
                            const option = document.createElement('option');
                            option.value = record.id;
                            option.textContent = `${femaleDog?.name || '未知'}（${femaleDog?.kennel || '未知'}）× ${maleDog?.name || '未知'}（${maleDog?.kennel || '未知'}） (${record.date})`;
                            birthBreedingSelect.appendChild(option);
                        }
                    });
                    
                    if (currentValue) {
                        birthBreedingSelect.value = currentValue;
                    }
                }
                
                // 填充母犬分娩记录选择框
                const motherBirthSelect = document.getElementById('mother-birth-select');
                if (motherBirthSelect) {
                    motherBirthSelect.innerHTML = '<option value="">请先选择母犬</option>';
                }
                
                // 填充犬舍号筛选框
                updateKennelFilter();
            }
            
            // 更新犬舍号筛选框
            function updateKennelFilter() {
                const kennelFilter = document.getElementById('filter-kennel');
                if (!kennelFilter) return;
                
                // 保存当前选中的值
                const currentValue = kennelFilter.value;
                
                // 获取所有犬舍号（去重）
                const kennels = [...new Set(Object.values(system.dogs).map(dog => dog.kennel).filter(kennel => kennel))].sort();
                
                // 清空选项（保留第一个选项）
                kennelFilter.innerHTML = '<option value="">所有犬舍</option>';
                
                // 添加犬舍号选项
                kennels.forEach(kennel => {
                    const option = document.createElement('option');
                    option.value = kennel;
                    option.textContent = kennel;
                    kennelFilter.appendChild(option);
                });
                
                // 恢复之前选中的值
                if (currentValue && Array.from(kennelFilter.options).some(opt => opt.value === currentValue)) {
                    kennelFilter.value = currentValue;
                }
            }
            
            // 渲染犬只列表
            function renderDogList(filter = {}) {
                const tableBody = document.getElementById('dogs-table-body');
                tableBody.innerHTML = '';
                
                Object.values(system.dogs)
                    .filter(dog => {
                        // 应用过滤器
                        if (filter.search) {
                            const searchTerm = filter.search.toLowerCase();
                            if (!(
                                dog.name.toLowerCase().includes(searchTerm) ||
                                dog.breed.toLowerCase().includes(searchTerm) ||
                                (dog.trainer && dog.trainer.toLowerCase().includes(searchTerm)) ||
                                (dog.chipId && dog.chipId.toLowerCase().includes(searchTerm)) ||
                                (dog.kennel && dog.kennel.toLowerCase().includes(searchTerm)) || // 新增：犬舍号搜索
                                (dog.fatherName && dog.fatherName.toLowerCase().includes(searchTerm)) ||
                                (dog.motherName && dog.motherName.toLowerCase().includes(searchTerm))
                            )) {
                                return false;
                            }
                        }
                        
                        // 新增：品种筛选
                        if (filter.breed && dog.breed !== filter.breed) {
                            return false;
                        }
                        
                        if (filter.gender && dog.gender !== filter.gender) {
                            return false;
                        }
                        
                        if (filter.status && dog.status !== filter.status) {
                            return false;
                        }
                        
                        // 新增：犬舍号筛选
                        if (filter.kennel && dog.kennel !== filter.kennel) {
                            return false;
                        }
                        
                        return true;
                    })
                    .forEach(dog => {
                        const row = document.createElement('tr');
                        
                        // 状态徽章
                        let statusBadge = '';
                        if (dog.status === '服役') statusBadge = '<span class="badge badge-success">服役</span>';
                        else if (dog.status === '在训') statusBadge = '<span class="badge badge-primary">在训</span>';
                        else if (dog.status === '繁殖') statusBadge = '<span class="badge badge-info">繁殖</span>';
                        else if (dog.status === '休养') statusBadge = '<span class="badge badge-warning">休养</span>';
                        else if (dog.status === '退役') statusBadge = '<span class="badge badge-danger">退役</span>';
                        
                        // 检查是否怀孕
                        const isPregnant = system.breedingRecords.some(record => 
                            record.femaleId === dog.id && record.status === 'pregnant'
                        );
                        
                        if (isPregnant && dog.gender === 'female') {
                            statusBadge += ' <span class="badge badge-danger">怀孕</span>';
                        }
                        
                        row.innerHTML = `
                            <td><strong>${dog.name}</strong> ${dog.chipId ? `<br><small>芯片: ${dog.chipId}</small>` : ''}</td>
                            <td>${dog.breed}</td>
                            <td>${dog.gender === 'male' ? '<span class="status-indicator status-healthy"></span>雄' : '<span class="status-indicator status-pregnant"></span>雌'}</td>
                            <td><span class="kennel-badge">${dog.kennel || '未分配'}</span></td>
                            <td>${calculateAge(dog.birthDate)}</td>
                            <td>${dog.trainer || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-dog-btn" data-id="${dog.id}"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-warning edit-dog-btn" data-id="${dog.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-dog-btn" data-id="${dog.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                
                // 添加事件监听器
                tableBody.querySelectorAll('.view-dog-btn').forEach(btn => {
                    btn.addEventListener('click', () => showDogDetail(btn.dataset.id));
                });
                
                tableBody.querySelectorAll('.edit-dog-btn').forEach(btn => {
                    btn.addEventListener('click', () => editDog(btn.dataset.id));
                });
                
                tableBody.querySelectorAll('.delete-dog-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteDog(btn.dataset.id));
                });
            }
            
            // 渲染发情记录
            function renderHeatRecords() {
                const tableBody = document.getElementById('heat-table-body');
                tableBody.innerHTML = '';
                
                system.heatRecords.forEach(record => {
                    const dog = system.dogs[record.dogId];
                    if (!dog) return;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${dog.name}</td>
                        <td>${dog.breed}</td>
                        <td><span class="kennel-badge">${dog.kennel || '未分配'}</span></td>
                        <td>${record.date}</td>
                        <td>${record.recordedDate}</td>
                        <td>${record.notes || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-heat-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // 添加删除事件监听器
                tableBody.querySelectorAll('.delete-heat-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteHeatRecord(btn.dataset.id));
                });
            }
            
            // 渲染配种记录
            function renderBreedingRecords() {
                const tableBody = document.getElementById('breeding-table-body');
                tableBody.innerHTML = '';
                
                system.breedingRecords.forEach(record => {
                    const femaleDog = system.dogs[record.femaleId];
                    const maleDog = system.dogs[record.maleId];
                    if (!femaleDog || !maleDog) return;
                    
                    // 状态显示
                    let statusBadge = '';
                    if (record.status === 'pregnant') statusBadge = '<span class="badge badge-danger">怀孕中</span>';
                    else if (record.status === 'delivered') statusBadge = '<span class="badge badge-success">已分娩</span>';
                    else if (record.status === 'cancelled') statusBadge = '<span class="badge badge-warning">已取消</span>';
                    
                    // 影像检查信息
                    const check1Info = record.check1Date ? 
                        `${record.check1Date}<br><small>${record.check1Result || '未填写结果'}</small>` : 
                        '未检查';
                    
                    const check2Info = record.check2Date ? 
                        `${record.check2Date}<br><small>${record.check2Result || '未填写结果'}</small>` : 
                        '未检查';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${femaleDog.name} (${femaleDog.breed})</td>
                        <td><span class="kennel-badge">${femaleDog.kennel || '未分配'}</span></td>
                        <td>${maleDog.name} (${maleDog.breed})</td>
                        <td><span class="kennel-badge">${maleDog.kennel || '未分配'}</span></td>
                        <td>${record.date}</td>
                        <td>${record.expectedDate || '-'}</td>
                        <td>${check1Info}</td>
                        <td>${check2Info}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${record.status === 'pregnant' ? `<button class="btn btn-sm btn-success record-birth-btn" data-id="${record.id}"><i class="fas fa-baby"></i></button>` : ''}
                            <button class="btn btn-sm btn-danger delete-breeding-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // 添加事件监听器
                tableBody.querySelectorAll('.record-birth-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const record = system.breedingRecords.find(r => r.id === btn.dataset.id);
                        if (record) {
                            document.getElementById('birth-female-id').value = record.femaleId;
                            document.getElementById('birth-breeding-id').value = record.id;
                            switchSection('record-birth');
                        }
                    });
                });
                
                tableBody.querySelectorAll('.delete-breeding-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteBreedingRecord(btn.dataset.id));
                });
            }
            
            // 渲染分娩记录
            function renderBirthRecords() {
                const tableBody = document.getElementById('birth-table-body');
                tableBody.innerHTML = '';
                
                system.birthRecords.forEach(record => {
                    const dog = system.dogs[record.dogId];
                    
                    if (!dog) return;
                    
                    // 获取幼犬预约信息
                    const schedule = system.puppySchedules.find(s => s.birthRecordId === record.id);
                    const dewormDate = schedule ? schedule.dewormDate : '未预约';
                    const vaccineDate = schedule ? schedule.vaccineDate : '未预约';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${dog.name} (${dog.breed})</td>
                        <td><span class="kennel-badge">${dog.kennel || '未分配'}</span></td>
                        <td>${record.date}</td>
                        <td>${record.puppyCount} 只</td>
                        <td>${dewormDate}</td>
                        <td>${vaccineDate}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-birth-btn" data-id="${record.id}"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-danger delete-birth-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // 添加事件监听器
                tableBody.querySelectorAll('.view-birth-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewBirthRecord(btn.dataset.id));
                });
                
                tableBody.querySelectorAll('.delete-birth-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteBirthRecord(btn.dataset.id));
                });
            }
            
            // 渲染免疫记录
            function renderVaccinationRecords() {
                const tableBody = document.getElementById('vaccination-table-body');
                tableBody.innerHTML = '';
                
                const today = new Date();
                
                system.vaccinationRecords.forEach(record => {
                    const dog = system.dogs[record.dogId];
                    if (!dog) return;
                    
                    // 计算剩余天数
                    let daysRemaining = '-';
                    let isDueSoon = false;
                    
                    if (record.nextDate) {
                        const nextDate = new Date(record.nextDate);
                        const diffTime = nextDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays >= 0) {
                            daysRemaining = `${diffDays} 天`;
                            isDueSoon = diffDays <= system.settings.reminderDays;
                        } else {
                            daysRemaining = `<span style="color: #dc3545;">已过期 ${Math.abs(diffDays)} 天</span>`;
                        }
                    }
                    
                    // 检查是否为自定义疫苗类型
                    const isCustomVaccine = vaccineManager.isCustomVaccineType(record.type);
                    const vaccineTypeDisplay = isCustomVaccine ? 
                        `${record.type} <span class="vaccine-other-tag">其他</span>` : 
                        record.type;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${dog.name} (${dog.breed})</td>
                        <td><span class="kennel-badge">${dog.kennel || '未分配'}</span></td>
                        <td>${vaccineTypeDisplay}</td>
                        <td>${record.date}</td>
                        <td>${record.nextDate || '-'}</td>
                        <td>${daysRemaining}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-vaccination-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    if (isDueSoon) {
                        row.style.backgroundColor = '#fff3cd';
                    }
                    
                    tableBody.appendChild(row);
                });
                
                // 添加删除事件监听器
                tableBody.querySelectorAll('.delete-vaccination-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteVaccinationRecord(btn.dataset.id));
                });
                
                // 更新免疫提醒
                updateVaccinationAlerts();
                
                // 更新疫苗类型历史记录
                updateVaccineHistory();
            }
            
            // 更新疫苗类型历史记录
            function updateVaccineHistory() {
                const historyList = document.getElementById('vaccine-history-list');
                const quickSelect = document.getElementById('vaccine-quick-select');
                
                if (!historyList || !quickSelect) return;
                
                const usedVaccineTypes = vaccineManager.getUsedVaccineTypes();
                const vaccineTypes = Object.keys(usedVaccineTypes)
                    .sort((a, b) => usedVaccineTypes[b] - usedVaccineTypes[a])
                    .slice(0, 10); // 只显示前10个最常用的
                
                // 更新历史记录列表
                if (vaccineTypes.length === 0) {
                    historyList.innerHTML = '<p style="color: #666; text-align: center;">暂无疫苗记录</p>';
                } else {
                    let historyHTML = '<h5 style="margin-bottom: 10px;">常用疫苗类型</h5>';
                    
                    vaccineTypes.forEach(type => {
                        const isCustom = vaccineManager.isCustomVaccineType(type);
                        const count = usedVaccineTypes[type];
                        
                        historyHTML += `
                            <div class="vaccine-history-item">
                                <div class="vaccine-history-name">
                                    ${type} ${isCustom ? '<span class="vaccine-other-tag">其他</span>' : ''}
                                </div>
                                <div class="vaccine-history-count">${count}次</div>
                            </div>
                        `;
                    });
                    
                    historyList.innerHTML = historyHTML;
                }
                
                // 更新快速选择按钮
                const vaccineTypeList = vaccineManager.getVaccineTypeList();
                let quickSelectHTML = '';
                
                // 预定义疫苗类型按钮
                vaccineManager.predefinedVaccines.forEach(type => {
                    quickSelectHTML += `<button type="button" class="vaccine-quick-btn" data-vaccine="${type}">${type}</button>`;
                });
                
                // 自定义疫苗类型按钮（最多显示5个）
                const customVaccines = vaccineTypeList.filter(type => !vaccineManager.predefinedVaccines.includes(type));
                customVaccines.slice(0, 5).forEach(type => {
                    quickSelectHTML += `<button type="button" class="vaccine-quick-btn" data-vaccine="${type}">${type}</button>`;
                });
                
                quickSelect.innerHTML = quickSelectHTML;
                
                // 为快速选择按钮添加事件监听器
                quickSelect.querySelectorAll('.vaccine-quick-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const vaccineType = this.dataset.vaccine;
                        document.getElementById('vaccination-type').value = vaccineType;
                        
                        // 如果是自定义类型，隐藏手动输入框
                        if (vaccineManager.predefinedVaccines.includes(vaccineType)) {
                            document.getElementById('custom-vaccine-container').classList.remove('active');
                            document.getElementById('custom-vaccine-name').value = '';
                        } else {
                            // 如果是自定义类型，显示手动输入框并填充值
                            document.getElementById('custom-vaccine-container').classList.add('active');
                            document.getElementById('custom-vaccine-name').value = vaccineType;
                        }
                        
                        // 更新快速选择按钮的激活状态
                        quickSelect.querySelectorAll('.vaccine-quick-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                });
            }
            
            // 更新免疫提醒
            function updateVaccinationAlerts() {
                const alertsContainer = document.getElementById('vaccination-alerts');
                alertsContainer.innerHTML = '';
                
                const today = new Date();
                const dueDate = new Date();
                dueDate.setDate(today.getDate() + system.settings.reminderDays);
                
                // 获取需要免疫的犬只
                const dueVaccinations = system.vaccinationRecords.filter(record => {
                    if (!record.nextDate) return false;
                    const nextDate = new Date(record.nextDate);
                    return nextDate >= today && nextDate <= dueDate;
                });
                
                if (dueVaccinations.length === 0) {
                    const alert = createAlertElement(`未来${system.settings.reminderDays}天内没有需要免疫的犬只。`, 'success');
                    alertsContainer.appendChild(alert);
                } else {
                    dueVaccinations.forEach(record => {
                        const dog = system.dogs[record.dogId];
                        const nextDate = new Date(record.nextDate);
                        const daysDiff = Math.floor((nextDate - today) / (1000 * 60 * 60 * 24));
                        
                        const alert = createAlertElement(
                            `犬只 "${dog?.name || '未知'}"（犬舍号：${dog?.kennel || '未知'}）的 ${record.type} ${daysDiff === 0 ? '今天' : `${daysDiff}天后`} 到期`,
                            daysDiff <= 7 ? 'danger' : 'warning'
                        );
                        alertsContainer.appendChild(alert);
                    });
                }
            }
            
            // 显示犬只详情
            function showDogDetail(dogId) {
                const dog = system.dogs[dogId];
                if (!dog) return;
                
                const modal = document.getElementById('dog-detail-modal');
                const content = document.getElementById('dog-detail-content');
                
                // 获取相关记录
                const heatRecords = system.heatRecords.filter(r => r.dogId === dogId);
                const breedingRecords = system.breedingRecords.filter(r => r.femaleId === dogId || r.maleId === dogId);
                const vaccinationRecords = system.vaccinationRecords.filter(r => r.dogId === dogId);
                const dewormingRecords = system.dewormingRecords.filter(r => r.dogId === dogId);
                
                // 检查是否怀孕
                const isPregnant = breedingRecords.some(r => r.status === 'pregnant' && r.femaleId === dogId);
                
                // 获取父母信息
                const fatherDog = dog.fatherId ? system.dogs[dog.fatherId] : null;
                const motherDog = dog.motherId ? system.dogs[dog.motherId] : null;
                
                let contentHTML = `
                    <div style="display: flex; align-items: flex-start; margin-bottom: 25px;">
                        <div style="flex: 1;">
                            <h3 style="color: #2c3e50; margin-bottom: 10px;">${dog.name} ${isPregnant && dog.gender === 'female' ? '<span class="badge badge-danger">怀孕中</span>' : ''}</h3>
                            <div style="color: #666; margin-bottom: 20px;">${dog.breed} · ${dog.gender === 'male' ? '雄性' : '雌性'} · ${calculateAge(dog.birthDate)} · 犬舍号: <span class="kennel-badge">${dog.kennel || '未分配'}</span></div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-sm btn-warning edit-dog-detail-btn" data-id="${dog.id}" style="margin-right: 10px;"><i class="fas fa-edit"></i> 编辑</button>
                        </div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">芯片ID</div>
                        <div class="dog-detail-value">${dog.chipId || '未录入'}</div>
                    </div>
                    
                    <!-- 新增：犬舍信息 -->
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">犬舍号</div>
                        <div class="dog-detail-value">${dog.kennel || '未分配'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">犬舍区域</div>
                        <div class="dog-detail-value">${dog.kennelArea || '未指定'}</div>
                    </div>
                    
                    <!-- 父母信息 -->
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">父亲</div>
                        <div class="dog-detail-value">
                            ${fatherDog ? `<a href="javascript:void(0)" class="view-parent-btn" data-id="${fatherDog.id}" style="color: #4a6491; text-decoration: none;">${fatherDog.name}</a> (${fatherDog.breed}, 犬舍: ${fatherDog.kennel || '未知'})` : (dog.fatherName || '未知')}
                        </div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">母亲</div>
                        <div class="dog-detail-value">
                            ${motherDog ? `<a href="javascript:void(0)" class="view-parent-btn" data-id="${motherDog.id}" style="color: #4a6491; text-decoration: none;">${motherDog.name}</a> (${motherDog.breed}, 犬舍: ${motherDog.kennel || '未知'})` : (dog.motherName || '未知')}
                        </div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">出生日期</div>
                        <div class="dog-detail-value">${dog.birthDate}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">毛色</div>
                        <div class="dog-detail-value">${dog.color || '未录入'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">来源</div>
                        <div class="dog-detail-value">${dog.origin || '未录入'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">训导员</div>
                        <div class="dog-detail-value">${dog.trainer || '未指定'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">健康状况</div>
                        <div class="dog-detail-value">${dog.health || '未录入'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">当前状态</div>
                        <div class="dog-detail-value">${dog.status || '未指定'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">备注</div>
                        <div class="dog-detail-value">${dog.notes || '无'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">创建日期</div>
                        <div class="dog-detail-value">${dog.createdDate || '未知'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">最后更新</div>
                        <div class="dog-detail-value">${dog.updatedDate || '未知'}</div>
                    </div>
                `;
                
                // 添加驱虫记录
                if (dewormingRecords.length > 0) {
                    contentHTML += `
                        <h4 style="margin-top: 30px; color: #2c3e50; padding-bottom: 10px; border-bottom: 1px solid #eee;">驱虫记录</h4>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                            <table style="width: 100%; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="padding: 10px;">日期</th>
                                        <th style="padding: 10px;">下次驱虫</th>
                                        <th style="padding: 10px;">备注</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dewormingRecords.map(record => `
                                        <tr>
                                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.date}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.nextDate || '-'}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.notes || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                // 添加发情记录
                if (heatRecords.length > 0 && dog.gender === 'female') {
                    contentHTML += `
                        <h4 style="margin-top: 30px; color: #2c3e50; padding-bottom: 10px; border-bottom: 1px solid #eee;">发情记录</h4>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                            <table style="width: 100%; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="padding: 10px;">日期</th>
                                        <th style="padding: 10px;">备注</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${heatRecords.map(record => `
                                        <tr>
                                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.date}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.notes || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                // 添加繁殖记录
                if (breedingRecords.length > 0) {
                    contentHTML += `
                        <h4 style="margin-top: 30px; color: #2c3e50; padding-bottom: 10px; border-bottom: 1px solid #eee;">繁殖记录</h4>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                            <table style="width: 100%; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="padding: 10px;">配种对象</th>
                                        <th style="padding: 10px;">犬舍号</th>
                                        <th style="padding: 10px;">日期</th>
                                        <th style="padding: 10px;">影像检查</th>
                                        <th style="padding: 10px;">状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${breedingRecords.map(record => {
                                        const partnerId = dog.gender === 'female' ? record.maleId : record.femaleId;
                                        const partnerDog = system.dogs[partnerId];
                                        let statusText = '';
                                        if (record.status === 'pregnant') statusText = '怀孕中';
                                        else if (record.status === 'delivered') statusText = '已分娩';
                                        else if (record.status === 'cancelled') statusText = '已取消';
                                        
                                        // 影像检查信息
                                        const checkInfo = [];
                                        if (record.check1Date) checkInfo.push(`第一次: ${record.check1Date} - ${record.check1Result || '无结果'}`);
                                        if (record.check2Date) checkInfo.push(`第二次: ${record.check2Date} - ${record.check2Result || '无结果'}`);
                                        
                                        return `
                                            <tr>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${partnerDog?.name || '未知'}</td>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${partnerDog?.kennel || '未知'}</td>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.date}</td>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                                    ${checkInfo.length > 0 ? checkInfo.join('<br>') : '无影像检查记录'}
                                                </td>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${statusText}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                // 添加免疫记录
                if (vaccinationRecords.length > 0) {
                    contentHTML += `
                        <h4 style="margin-top: 30px; color: #2c3e50; padding-bottom: 10px; border-bottom: 1px solid #eee;">免疫记录</h4>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                            <table style="width: 100%; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="padding: 10px;">疫苗类型</th>
                                        <th style="padding: 10px;">免疫日期</th>
                                        <th style="padding: 10px;">下次免疫</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${vaccinationRecords.map(record => {
                                        const isCustom = vaccineManager.isCustomVaccineType(record.type);
                                        const vaccineTypeDisplay = isCustom ? 
                                            `${record.type} <span class="vaccine-other-tag">其他</span>` : 
                                            record.type;
                                        
                                        return `
                                            <tr>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${vaccineTypeDisplay}</td>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.date}</td>
                                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${record.nextDate || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                content.innerHTML = contentHTML;
                modal.classList.add('active');
                
                // 添加编辑按钮事件监听器
                const editBtn = content.querySelector('.edit-dog-detail-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        editDog(dogId);
                        modal.classList.remove('active');
                    });
                }
                
                // 添加查看父母按钮事件监听器
                content.querySelectorAll('.view-parent-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const parentId = this.dataset.id;
                        if (parentId && system.dogs[parentId]) {
                            modal.classList.remove('active');
                            setTimeout(() => showDogDetail(parentId), 300);
                        }
                    });
                });
            }
            
            // 编辑犬只
            function editDog(dogId) {
                const dog = system.dogs[dogId];
                if (!dog) return;
                
                // 填充表单
                document.getElementById('dog-name').value = dog.name;
                document.getElementById('dog-breed').value = dog.breed;
                document.getElementById('dog-gender').value = dog.gender;
                document.getElementById('dog-birthdate').value = dog.birthDate;
                document.getElementById('dog-color').value = dog.color || '';
                document.getElementById('dog-chip').value = dog.chipId || '';
                document.getElementById('dog-kennel').value = dog.kennel || ''; // 新增：犬舍号
                document.getElementById('dog-kennel-area').value = dog.kennelArea || ''; // 新增：犬舍区域
                document.getElementById('dog-origin').value = dog.origin || '';
                document.getElementById('dog-trainer').value = dog.trainer || '';
                document.getElementById('dog-health').value = dog.health || '健康';
                document.getElementById('dog-status').value = dog.status || '在训';
                document.getElementById('dog-notes').value = dog.notes || '';
                
                // 填充父母信息
                const fatherInput = document.getElementById('dog-father-name');
                const motherInput = document.getElementById('dog-mother-name');
                const fatherHidden = document.getElementById('dog-father-id');
                const motherHidden = document.getElementById('dog-mother-id');
                const clearFatherBtn = document.getElementById('clear-father-btn');
                const clearMotherBtn = document.getElementById('clear-mother-btn');
                
                if (dog.fatherId && system.dogs[dog.fatherId]) {
                    const fatherDog = system.dogs[dog.fatherId];
                    fatherInput.value = fatherDog.name;
                    fatherHidden.value = fatherDog.id;
                    clearFatherBtn.style.display = 'inline-block';
                } else if (dog.fatherName) {
                    fatherInput.value = dog.fatherName;
                    fatherHidden.value = '';
                    clearFatherBtn.style.display = 'inline-block';
                }
                
                if (dog.motherId && system.dogs[dog.motherId]) {
                    const motherDog = system.dogs[dog.motherId];
                    motherInput.value = motherDog.name;
                    motherHidden.value = motherDog.id;
                    clearMotherBtn.style.display = 'inline-block';
                } else if (dog.motherName) {
                    motherInput.value = dog.motherName;
                    motherHidden.value = '';
                    clearMotherBtn.style.display = 'inline-block';
                }
                
                // 切换到添加犬只页面
                switchSection('add-dog');
                
                // 修改表单提交行为为更新
                const form = document.getElementById('add-dog-form');
                const originalSubmit = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    
                    // 更新犬只信息
                    dog.name = document.getElementById('dog-name').value;
                    dog.breed = document.getElementById('dog-breed').value;
                    dog.gender = document.getElementById('dog-gender').value;
                    dog.birthDate = document.getElementById('dog-birthdate').value;
                    dog.color = document.getElementById('dog-color').value;
                    dog.chipId = document.getElementById('dog-chip').value || null;
                    dog.kennel = document.getElementById('dog-kennel').value; // 新增：犬舍号
                    dog.kennelArea = document.getElementById('dog-kennel-area').value || null; // 新增：犬舍区域
                    dog.origin = document.getElementById('dog-origin').value;
                    dog.trainer = document.getElementById('dog-trainer').value;
                    dog.health = document.getElementById('dog-health').value;
                    dog.status = document.getElementById('dog-status').value;
                    dog.notes = document.getElementById('dog-notes').value;
                    
                    // 更新父母信息
                    dog.fatherId = document.getElementById('dog-father-id').value || null;
                    dog.fatherName = document.getElementById('dog-father-name').value || '';
                    dog.motherId = document.getElementById('dog-mother-id').value || null;
                    dog.motherName = document.getElementById('dog-mother-name').value || '';
                    
                    // 如果父亲/母亲ID存在但名字为空，从系统中获取名字
                    if (dog.fatherId && !dog.fatherName && system.dogs[dog.fatherId]) {
                        dog.fatherName = system.dogs[dog.fatherId].name;
                    }
                    if (dog.motherId && !dog.motherName && system.dogs[dog.motherId]) {
                        dog.motherName = system.dogs[dog.motherId].name;
                    }
                    
                    dog.updatedDate = new Date().toISOString().split('T')[0];
                    
                    if (saveData()) {
                        showAlert(`犬只 "${dog.name}" 信息更新成功！`, 'success');
                        updateDashboard();
                        populateDogSelects();
                        renderDogList();
                        resetAddDogForm();
                        form.onsubmit = originalSubmit;
                        switchSection('view-dogs');
                    }
                };
                
                // 显示更新按钮
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save"></i> 更新犬只信息';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-warning');
                
                // 添加取消按钮
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.innerHTML = '<i class="fas fa-times"></i> 取消编辑';
                cancelBtn.onclick = function() {
                    resetAddDogForm();
                    form.onsubmit = originalSubmit;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> 保存犬只信息';
                    submitBtn.classList.remove('btn-warning');
                    submitBtn.classList.add('btn-primary');
                    cancelBtn.remove();
                };
                
                const buttonGroup = form.querySelector('.button-group');
                buttonGroup.appendChild(cancelBtn);
            }
            
            // 删除犬只
            function deleteDog(dogId) {
                const dog = system.dogs[dogId];
                if (!dog) return;
                
                showConfirmModal(
                    `确定要删除犬只 "${dog.name}"（犬舍号：${dog.kennel || '未知'}）吗？此操作将删除该犬只的所有相关记录，且无法恢复！`,
                    function() {
                        delete system.dogs[dogId];
                        
                        // 删除相关记录
                        system.heatRecords = system.heatRecords.filter(r => r.dogId !== dogId);
                        system.breedingRecords = system.breedingRecords.filter(r => 
                            r.femaleId !== dogId && r.maleId !== dogId
                        );
                        system.vaccinationRecords = system.vaccinationRecords.filter(r => r.dogId !== dogId);
                        system.dewormingRecords = system.dewormingRecords.filter(r => r.dogId !== dogId);
                        
                        // 更新其他犬只的父母信息（如果被删除的犬只是其他犬只的父母）
                        Object.values(system.dogs).forEach(otherDog => {
                            if (otherDog.fatherId === dogId) {
                                otherDog.fatherId = null;
                                // 保留父亲名字作为记录
                                if (!otherDog.fatherName) {
                                    otherDog.fatherName = dog.name;
                                }
                            }
                            if (otherDog.motherId === dogId) {
                                otherDog.motherId = null;
                                // 保留母亲名字作为记录
                                if (!otherDog.motherName) {
                                    otherDog.motherName = dog.name;
                                }
                            }
                        });
                        
                        if (saveData()) {
                            showAlert(`犬只 "${dog.name}" 已删除！`, 'success');
                            updateDashboard();
                            populateDogSelects();
                            renderDogList();
                            renderHeatRecords();
                            renderBreedingRecords();
                            renderVaccinationRecords();
                        }
                    }
                );
            }
            
            // 删除发情记录
            function deleteHeatRecord(recordId) {
                const record = system.heatRecords.find(r => r.id === recordId);
                if (!record) return;
                
                const dog = system.dogs[record.dogId];
                
                showConfirmModal(
                    `确定要删除这条发情记录吗？`,
                    function() {
                        system.heatRecords = system.heatRecords.filter(r => r.id !== recordId);
                        
                        if (saveData()) {
                            showAlert(`发情记录已删除！`, 'success');
                            renderHeatRecords();
                        }
                    }
                );
            }
            
            // 删除配种记录
            function deleteBreedingRecord(recordId) {
                const record = system.breedingRecords.find(r => r.id === recordId);
                if (!record) return;
                
                const femaleDog = system.dogs[record.femaleId];
                const maleDog = system.dogs[record.maleId];
                
                showConfirmModal(
                    `确定要删除 "${femaleDog?.name || '未知'}"（犬舍号：${femaleDog?.kennel || '未知'}）和 "${maleDog?.name || '未知'}"（犬舍号：${maleDog?.kennel || '未知'}）的配种记录吗？`,
                    function() {
                        system.breedingRecords = system.breedingRecords.filter(r => r.id !== recordId);
                        
                        if (saveData()) {
                            showAlert(`配种记录已删除！`, 'success');
                            renderBreedingRecords();
                            updateDashboard();
                        }
                    }
                );
            }
            
            // 删除分娩记录
            function deleteBirthRecord(recordId) {
                const record = system.birthRecords.find(r => r.id === recordId);
                if (!record) return;
                
                const dog = system.dogs[record.dogId];
                
                showConfirmModal(
                    `确定要删除这条分娩记录吗？`,
                    function() {
                        system.birthRecords = system.birthRecords.filter(r => r.id !== recordId);
                        
                        // 删除相关的幼犬预约记录
                        system.puppySchedules = system.puppySchedules.filter(s => s.birthRecordId !== recordId);
                        
                        // 更新对应的配种记录状态
                        const breedingRecord = system.breedingRecords.find(r => r.id === record.breedingId);
                        if (breedingRecord) {
                            breedingRecord.status = 'pregnant';
                            delete breedingRecord.actualDate;
                            delete breedingRecord.puppyCount;
                        }
                        
                        if (saveData()) {
                            showAlert(`分娩记录已删除！`, 'success');
                            renderBirthRecords();
                            renderBreedingRecords();
                            updateDashboard();
                        }
                    }
                );
            }
            
            // 删除免疫记录
            function deleteVaccinationRecord(recordId) {
                const record = system.vaccinationRecords.find(r => r.id === recordId);
                if (!record) return;
                
                showConfirmModal(
                    `确定要删除这条免疫记录吗？`,
                    function() {
                        system.vaccinationRecords = system.vaccinationRecords.filter(r => r.id !== recordId);
                        
                        if (saveData()) {
                            showAlert(`免疫记录已删除！`, 'success');
                            renderVaccinationRecords();
                            updateDashboard();
                        }
                    }
                );
            }
            
            // 查看分娩记录详情
            function viewBirthRecord(recordId) {
                const record = system.birthRecords.find(r => r.id === recordId);
                if (!record) return;
                
                const dog = system.dogs[record.dogId];
                const breedingRecord = system.breedingRecords.find(r => r.id === record.breedingId);
                const schedule = system.puppySchedules.find(s => s.birthRecordId === recordId);
                
                let puppyDetails = '';
                if (record.puppyDetails && record.puppyDetails.length > 0) {
                    puppyDetails = `
                        <h4>幼犬详情</h4>
                        <table style="width: 100%; font-size: 0.9rem; margin-top: 10px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 10px;">编号</th>
                                    <th style="padding: 10px;">性别</th>
                                    <th style="padding: 10px;">毛色</th>
                                    <th style="padding: 10px;">体重(kg)</th>
                                    <th style="padding: 10px;">健康状况</th>
                                </tr>
                            </thead>
                                <tbody>
                                ${record.puppyDetails.map((puppy, index) => `
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${index + 1}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${puppy.gender === 'male' ? '雄' : '雌'}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${puppy.color || '-'}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${puppy.weight || '-'}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${puppy.healthStatus || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                const modal = document.getElementById('dog-detail-modal');
                const content = document.getElementById('dog-detail-content');
                
                content.innerHTML = `
                    <h3 style="color: #2c3e50; margin-bottom: 20px;"><i class="fas fa-baby"></i> 分娩记录详情</h3>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">雌性犬</div>
                        <div class="dog-detail-value">${dog?.name || '未知'} (${dog?.breed || '未知'})</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">犬舍号</div>
                        <div class="dog-detail-value"><span class="kennel-badge">${dog?.kennel || '未分配'}</span></div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">分娩日期</div>
                        <div class="dog-detail-value">${record.date}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">幼犬数量</div>
                        <div class="dog-detail-value">${record.puppyCount} 只</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">配种日期</div>
                        <div class="dog-detail-value">${breedingRecord ? breedingRecord.date : '未知'}</div>
                    </div>
                    
                    ${schedule ? `
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">首次驱虫预约</div>
                        <div class="dog-detail-value">${schedule.dewormDate || '未预约'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">首次免疫预约</div>
                        <div class="dog-detail-value">${schedule.vaccineDate || '未预约'}</div>
                    </div>
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">幼犬健康备注</div>
                        <div class="dog-detail-value">${schedule.notes || '无'}</div>
                    </div>
                    ` : ''}
                    
                    <div class="dog-detail-row">
                        <div class="dog-detail-label">备注</div>
                        <div class="dog-detail-value">${record.notes || '无'}</div>
                    </div>
                    
                    ${puppyDetails}
                `;
                
                modal.classList.add('active');
            }
            
            // 重置添加犬只表单
            function resetAddDogForm() {
                document.getElementById('add-dog-form').reset();
                const submitBtn = document.querySelector('#add-dog-form button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save"></i> 保存犬只信息';
                submitBtn.classList.remove('btn-warning');
                submitBtn.classList.add('btn-primary');
                
                // 清除父母搜索输入框和隐藏字段
                document.getElementById('dog-father-name').value = '';
                document.getElementById('dog-father-id').value = '';
                document.getElementById('dog-mother-name').value = '';
                document.getElementById('dog-mother-id').value = '';
                document.getElementById('clear-father-btn').style.display = 'none';
                document.getElementById('clear-mother-btn').style.display = 'none';
                
                const previewCard = document.getElementById('preview-card');
                previewCard.style.display = 'none';
            }
            
            // 显示确认模态框
            function showConfirmModal(message, confirmCallback) {
                const modal = document.getElementById('confirm-modal');
                const messageEl = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');
                
                messageEl.textContent = message;
                
                const handleConfirm = function() {
                    modal.classList.remove('active');
                    confirmCallback();
                    confirmBtn.removeEventListener('click', handleConfirm);
                };
                
                const handleCancel = function() {
                    modal.classList.remove('active');
                    confirmBtn.removeEventListener('click', handleConfirm);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                
                modal.classList.add('active');
            }
            
            // 切换内容区域 - 修复后的版本
            function switchSection(sectionId) {
                console.log('切换至:', sectionId);
                
                // 更新菜单激活状态
                const menuLinks = document.querySelectorAll('.sidebar-menu a');
                menuLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-section') === sectionId) {
                        link.classList.add('active');
                    }
                });
                
                // 显示对应内容区域
                const contentSections = document.querySelectorAll('.content-section');
                contentSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === sectionId) {
                        section.classList.add('active');
                    }
                });
                
                // 如果是查看犬只页面，刷新列表
                if (sectionId === 'view-dogs') {
                    renderDogList();
                }
                
                // 如果是仪表盘页面，刷新统计
                if (sectionId === 'dashboard') {
                    updateDashboard();
                }
                
                // 如果是免疫记录页面，更新疫苗历史
                if (sectionId === 'record-vaccination') {
                    updateVaccineHistory();
                }
                
                // 如果是添加犬只页面，隐藏搜索结果
                if (sectionId === 'add-dog') {
                    const fatherResults = document.getElementById('father-search-results');
                    const motherResults = document.getElementById('mother-search-results');
                    if (fatherResults) fatherResults.style.display = 'none';
                    if (motherResults) motherResults.style.display = 'none';
                }
                
                // 滚动到顶部
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    contentArea.scrollTop = 0;
                }
            }
            
            // 显示提示消息
            function showAlert(message, type) {
                // 创建临时提示元素
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.style.position = 'fixed';
                alert.style.top = '20px';
                alert.style.right = '20px';
                alert.style.zIndex = '9999';
                alert.style.minWidth = '300px';
                alert.style.maxWidth = '500px';
                alert.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                
                let icon = 'info-circle';
                if (type === 'danger') icon = 'exclamation-triangle';
                if (type === 'warning') icon = 'exclamation-circle';
                if (type === 'success') icon = 'check-circle';
                
                alert.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <div style="flex: 1;">${message}</div>
                    <button type="button" class="btn-close" style="background: none; border: none; font-size: 1.2rem; color: inherit; cursor: pointer;">&times;</button>
                `;
                
                document.body.appendChild(alert);
                
                // 添加关闭按钮事件
                const closeBtn = alert.querySelector('.btn-close');
                closeBtn.addEventListener('click', () => {
                    alert.remove();
                });
                
                // 5秒后自动消失
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 5000);
            }
            
            // 创建备份
            function createBackup() {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const backupData = {
                    system: system,
                    backupDate: new Date().toISOString(),
                    version: system.version
                };
                
                const backupKey = `dogBreedingBackup_${timestamp}`;
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // 更新备份列表
                updateBackupList();
                
                return backupKey;
            }
            
            // 更新备份列表
            function updateBackupList() {
                const backupList = document.getElementById('backup-list');
                if (!backupList) return;
                
                // 获取所有备份
                const backups = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('dogBreedingBackup_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            backups.push({
                                key: key,
                                date: data.backupDate,
                                version: data.version
                            });
                        } catch (e) {
                            console.error('解析备份数据失败:', key, e);
                        }
                    }
                }
                
                // 按日期排序
                backups.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (backups.length === 0) {
                    backupList.innerHTML = '<p>暂无备份数据。</p>';
                    return;
                }
                
                let html = '<h4>现有备份：</h4><ul style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;">';
                
                backups.forEach(backup => {
                    const date = new Date(backup.date);
                    const formattedDate = date.toLocaleString('zh-CN');
                    
                    html += `
                        <li style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${formattedDate}</strong><br>
                                <small>版本: ${backup.version}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-info restore-backup-btn" data-key="${backup.key}">恢复</button>
                                <button class="btn btn-sm btn-danger delete-backup-btn" data-key="${backup.key}">删除</button>
                            </div>
                        </li>
                    `;
                });
                
                html += '</ul>';
                backupList.innerHTML = html;
                
                // 添加事件监听器
                backupList.querySelectorAll('.restore-backup-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const backupKey = btn.dataset.key;
                        restoreBackup(backupKey);
                    });
                });
                
                backupList.querySelectorAll('.delete-backup-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const backupKey = btn.dataset.key;
                        deleteBackup(backupKey);
                    });
                });
            }
            
            // 恢复备份
            function restoreBackup(backupKey) {
                showConfirmModal(
                    '确定要恢复此备份吗？当前所有数据将被覆盖！',
                    function() {
                        try {
                            const backupData = JSON.parse(localStorage.getItem(backupKey));
                            if (backupData && backupData.system) {
                                Object.assign(system, backupData.system);
                                
                                if (saveData()) {
                                    showAlert('备份恢复成功！系统将重新加载。', 'success');
                                    
                                    // 重新加载页面以应用恢复的数据
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1500);
                                }
                            } else {
                                showAlert('备份数据格式错误！', 'danger');
                            }
                        } catch (e) {
                            console.error('恢复备份失败:', e);
                            showAlert('恢复备份失败！', 'danger');
                        }
                    }
                );
            }
            
            // 删除备份
            function deleteBackup(backupKey) {
                showConfirmModal(
                    '确定要删除此备份吗？',
                    function() {
                        localStorage.removeItem(backupKey);
                        updateBackupList();
                        showAlert('备份已删除！', 'success');
                    }
                );
            }
            
            // 导出数据为JSON文件
            function exportDataAsJSON() {
                const exportData = {
                    system: system,
                    exportDate: new Date().toISOString(),
                    version: system.version
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `警犬繁育管理系统备份_${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showAlert('数据导出成功！', 'success');
            }
            
            // 导入数据从JSON文件
            function importDataFromJSON(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        showConfirmModal(
                            '确定要导入此数据文件吗？当前所有数据将被覆盖！',
                            function() {
                                if (importData && importData.system) {
                                    Object.assign(system, importData.system);
                                    
                                    if (saveData()) {
                                        showAlert('数据导入成功！系统将重新加载。', 'success');
                                        
                                        // 重新加载页面以应用导入的数据
                                        setTimeout(() => {
                                            location.reload();
                                        }, 1500);
                                    }
                                } else {
                                    showAlert('导入数据格式错误！', 'danger');
                                }
                            }
                        );
                    } catch (e) {
                        console.error('解析导入文件失败:', e);
                        showAlert('导入文件格式错误！', 'danger');
                    }
                };
                
                reader.readAsText(file);
            }
            
            // ==================== 新增功能函数 ====================
            
            // 快速添加雌性犬
            function quickAddMother() {
                const modal = document.getElementById('quick-add-mother-modal');
                const form = document.getElementById('quick-add-mother-form');
                
                // 显示模态框
                modal.classList.add('active');
                
                // 设置默认出生日期为2年前
                const defaultDate = new Date();
                defaultDate.setFullYear(defaultDate.getFullYear() - 2);
                document.getElementById('quick-mother-birthdate').value = defaultDate.toISOString().split('T')[0];
                
                // 表单提交处理
                form.onsubmit = function(e) {
                    e.preventDefault();
                    
                    const dogId = generateId('DOG');
                    const now = new Date().toISOString().split('T')[0];
                    
                    const newDog = {
                        id: dogId,
                        name: document.getElementById('quick-mother-name').value,
                        breed: document.getElementById('quick-mother-breed').value,
                        gender: 'female',
                        birthDate: document.getElementById('quick-mother-birthdate').value,
                        color: document.getElementById('quick-mother-color').value || null,
                        chipId: null,
                        kennel: document.getElementById('quick-mother-kennel').value, // 新增：犬舍号
                        kennelArea: '繁殖区', // 默认设为繁殖区
                        origin: null,
                        trainer: null,
                        health: '健康',
                        status: document.getElementById('quick-mother-status').value,
                        notes: '快速添加的雌性犬',
                        fatherId: null,
                        fatherName: '',
                        motherId: null,
                        motherName: '',
                        createdDate: now,
                        updatedDate: now
                    };
                    
                    system.dogs[dogId] = newDog;
                    
                    if (saveData()) {
                        showAlert(`雌性犬 "${newDog.name}" 添加成功！`, 'success');
                        
                        // 更新选择框
                        populateDogSelects();
                        
                        // 设置分娩记录中的雌性犬选择
                        const birthFemaleSelect = document.getElementById('birth-female-id');
                        if (birthFemaleSelect) {
                            birthFemaleSelect.value = dogId;
                        }
                        
                        // 关闭模态框
                        modal.classList.remove('active');
                        form.reset();
                    }
                };
            }
            
            // 更新母犬关联的幼犬列表
            function updateMotherPuppyList(motherId, birthRecordId = null) {
                const puppyList = document.getElementById('puppy-list');
                const puppyContainer = document.getElementById('puppy-selection-container');
                
                if (!puppyList || !puppyContainer) return;
                
                puppyList.innerHTML = '';
                
                if (!motherId) {
                    puppyContainer.style.display = 'none';
                    return;
                }
                
                // 获取该母犬的分娩记录
                let birthRecords = system.birthRecords.filter(record => record.dogId === motherId);
                
                // 如果指定了分娩记录ID，只显示该记录
                if (birthRecordId) {
                    birthRecords = birthRecords.filter(record => record.id === birthRecordId);
                }
                
                if (birthRecords.length === 0) {
                    puppyList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">该母犬暂无分娩记录</p>';
                    puppyContainer.style.display = 'block';
                    return;
                }
                
                // 显示幼犬列表
                birthRecords.forEach(record => {
                    const recordHeader = document.createElement('div');
                    recordHeader.style.padding = '10px';
                    recordHeader.style.backgroundColor = '#f8f9fa';
                    recordHeader.style.borderBottom = '1px solid #dee2e6';
                    recordHeader.innerHTML = `<strong>分娩记录: ${record.date} (${record.puppyCount}只幼犬)</strong>`;
                    puppyList.appendChild(recordHeader);
                    
                    // 显示幼犬详细信息
                    if (record.puppyDetails && record.puppyDetails.length > 0) {
                        record.puppyDetails.forEach((puppy, index) => {
                            const puppyOption = document.createElement('div');
                            puppyOption.className = 'puppy-option';
                            
                            // 生成幼犬临时ID
                            const puppyTempId = `puppy-${record.id}-${index}`;
                            
                            puppyOption.innerHTML = `
                                <input type="checkbox" id="${puppyTempId}" value="${puppyTempId}" data-record-id="${record.id}" data-puppy-index="${index}">
                                <div class="puppy-info">
                                    <div class="puppy-name">幼犬 ${index + 1}</div>
                                    <div class="puppy-details">
                                        性别: ${puppy.gender === 'male' ? '雄' : '雌'} | 
                                        毛色: ${puppy.color || '未知'} | 
                                        体重: ${puppy.weight || '未知'}kg | 
                                        健康: ${puppy.healthStatus || '未知'}
                                    </div>
                                </div>
                            `;
                            
                            puppyList.appendChild(puppyOption);
                        });
                    } else {
                        // 如果没有详细幼犬信息，显示简单计数
                        for (let i = 0; i < record.puppyCount; i++) {
                            const puppyOption = document.createElement('div');
                            puppyOption.className = 'puppy-option';
                            
                            const puppyTempId = `puppy-${record.id}-${i}`;
                            
                            puppyOption.innerHTML = `
                                <input type="checkbox" id="${puppyTempId}" value="${puppyTempId}" data-record-id="${record.id}" data-puppy-index="${i}">
                                <div class="puppy-info">
                                    <div class="puppy-name">幼犬 ${i + 1}</div>
                                    <div class="puppy-details">性别未知</div>
                                </div>
                            `;
                            
                            puppyList.appendChild(puppyOption);
                        }
                    }
                });
                
                puppyContainer.style.display = 'block';
            }
            
            // 为选中的幼犬创建免疫记录
            function createVaccinationForPuppies(vaccineType, vaccineDate, nextDate, notes) {
                const selectedPuppies = document.querySelectorAll('#puppy-list input[type="checkbox"]:checked');
                
                if (selectedPuppies.length === 0) {
                    return false;
                }
                
                selectedPuppies.forEach(puppyCheckbox => {
                    const recordId = puppyCheckbox.dataset.recordId;
                    const puppyIndex = parseInt(puppyCheckbox.dataset.puppyIndex);
                    
                    // 创建幼犬的临时犬只记录
                    const birthRecord = system.birthRecords.find(r => r.id === recordId);
                    if (!birthRecord) return;
                    
                    const motherDog = system.dogs[birthRecord.dogId];
                    const puppyDetails = birthRecord.puppyDetails && birthRecord.puppyDetails[puppyIndex];
                    
                    // 生成幼犬ID
                    const puppyId = generateId('PUPPY');
                    
                    // 创建幼犬记录
                    const puppyDog = {
                        id: puppyId,
                        name: `${motherDog?.name || '母犬'}的幼犬-${puppyIndex + 1}`,
                        breed: motherDog?.breed || '未知',
                        gender: puppyDetails?.gender || 'unknown',
                        birthDate: birthRecord.date,
                        color: puppyDetails?.color || null,
                        chipId: null,
                        kennel: motherDog?.kennel ? `${motherDog.kennel}-幼${puppyIndex + 1}` : null, // 新增：基于母犬犬舍号生成幼犬犬舍号
                        kennelArea: '幼犬区', // 新增：默认设为幼犬区
                        origin: motherDog?.origin || null,
                        trainer: null,
                        health: puppyDetails?.healthStatus || '良好',
                        status: '幼犬',
                        notes: `母犬: ${motherDog?.name || '未知'} | 分娩日期: ${birthRecord.date}`,
                        fatherId: null,
                        fatherName: '未知',
                        motherId: motherDog?.id || null,
                        motherName: motherDog?.name || '未知',
                        createdDate: new Date().toISOString().split('T')[0],
                        updatedDate: new Date().toISOString().split('T')[0]
                    };
                    
                    // 添加到系统
                    system.dogs[puppyId] = puppyDog;
                    
                    // 创建免疫记录
                    const vaccinationId = generateId('VACC');
                    const now = new Date().toISOString().split('T')[0];
                    
                    const newRecord = {
                        id: vaccinationId,
                        dogId: puppyId,
                        type: vaccineType,
                        date: vaccineDate,
                        nextDate: nextDate,
                        notes: `幼犬首次免疫 | ${notes || ''}`,
                        recordedDate: now
                    };
                    
                    system.vaccinationRecords.push(newRecord);
                });
                
                return true;
            }
            
            // 生成统计报告
            function generateReport(reportType, reportPeriod) {
                const reportResults = document.getElementById('report-results');
                reportResults.innerHTML = '';
                
                let reportHTML = '';
                const today = new Date();
                
                // 根据报告类型生成不同的报告
                switch(reportType) {
                    case 'summary':
                        reportHTML = generateSummaryReport(reportPeriod);
                        break;
                    case 'breed':
                        reportHTML = generateBreedReport(reportPeriod);
                        break;
                    case 'kennel':
                        reportHTML = generateKennelReport(reportPeriod);
                        break;
                    case 'breeding':
                        reportHTML = generateBreedingReport(reportPeriod);
                        break;
                    case 'vaccination':
                        reportHTML = generateVaccinationReport(reportPeriod);
                        break;
                    case 'health':
                        reportHTML = generateHealthReport(reportPeriod);
                        break;
                    default:
                        reportHTML = generateSummaryReport(reportPeriod);
                }
                
                reportResults.innerHTML = reportHTML;
            }
            
            // 生成犬舍分布报告
            function generateKennelReport(reportPeriod) {
                // 统计犬舍分布
                const kennelStats = {};
                Object.values(system.dogs).forEach(dog => {
                    const kennel = dog.kennel || '未分配';
                    if (!kennelStats[kennel]) {
                        kennelStats[kennel] = {
                            total: 0,
                            male: 0,
                            female: 0,
                            breeds: {}
                        };
                    }
                    
                    kennelStats[kennel].total++;
                    if (dog.gender === 'male') kennelStats[kennel].male++;
                    if (dog.gender === 'female') kennelStats[kennel].female++;
                    
                    // 统计品种
                    const breed = dog.breed;
                    if (!kennelStats[kennel].breeds[breed]) {
                        kennelStats[kennel].breeds[breed] = 0;
                    }
                    kennelStats[kennel].breeds[breed]++;
                });
                
                let html = '<h4>犬舍分布统计</h4>';
                
                // 按犬舍排序
                const kennels = Object.keys(kennelStats).sort();
                
                if (kennels.length === 0) {
                    html += '<p>暂无犬舍数据</p>';
                    return html;
                }
                
                html += '<div style="overflow-x: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                html += '<thead><tr style="background-color: #f8f9fa;">';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6;">犬舍号</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6;">总犬只数</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6;">雄性犬</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6;">雌性犬</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6;">品种分布</th>';
                html += '</tr></thead><tbody>';
                
                kennels.forEach(kennel => {
                    const stats = kennelStats[kennel];
                    const breedList = Object.entries(stats.breeds)
                        .map(([breed, count]) => `${breed}: ${count}`)
                        .join(', ');
                    
                    html += '<tr>';
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${kennel}</strong></td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stats.total}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stats.male}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stats.female}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${breedList || '无'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                return html;
            }
            
            // ==================== 设置事件监听器 ====================
            
            function setupEventListeners() {
                console.log('设置事件监听器...');
                
                // 修复侧边栏菜单点击事件
                const sidebarMenu = document.querySelector('.sidebar-menu');
                if (sidebarMenu) {
                    sidebarMenu.addEventListener('click', function(e) {
                        // 确保点击的是链接元素
                        const link = e.target.closest('a');
                        if (link && link.hasAttribute('data-section')) {
                            e.preventDefault();
                            const sectionId = link.getAttribute('data-section');
                            console.log('点击菜单:', sectionId);
                            switchSection(sectionId);
                        }
                    });
                }
                
                // 添加犬只表单提交
                const addDogForm = document.getElementById('add-dog-form');
                if (addDogForm) {
                    addDogForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const dogId = generateId('DOG');
                        const now = new Date().toISOString().split('T')[0];
                        
                        // 获取父母信息
                        const fatherNameInput = document.getElementById('dog-father-name').value.trim();
                        const fatherIdInput = document.getElementById('dog-father-id').value;
                        const motherNameInput = document.getElementById('dog-mother-name').value.trim();
                        const motherIdInput = document.getElementById('dog-mother-id').value;
                        
                        // 确定父亲信息
                        let fatherId = null;
                        let fatherName = '';
                        if (fatherIdInput) {
                            fatherId = fatherIdInput;
                            // 从系统中获取父亲名字
                            const fatherDog = system.dogs[fatherId];
                            fatherName = fatherDog ? fatherDog.name : fatherNameInput;
                        } else if (fatherNameInput) {
                            fatherName = fatherNameInput;
                        }
                        
                        // 确定母亲信息
                        let motherId = null;
                        let motherName = '';
                        if (motherIdInput) {
                            motherId = motherIdInput;
                            // 从系统中获取母亲名字
                            const motherDog = system.dogs[motherId];
                            motherName = motherDog ? motherDog.name : motherNameInput;
                        } else if (motherNameInput) {
                            motherName = motherNameInput;
                        }
                        
                        const newDog = {
                            id: dogId,
                            name: document.getElementById('dog-name').value,
                            breed: document.getElementById('dog-breed').value,
                            gender: document.getElementById('dog-gender').value,
                            birthDate: document.getElementById('dog-birthdate').value,
                            color: document.getElementById('dog-color').value || null,
                            chipId: document.getElementById('dog-chip').value || null,
                            kennel: document.getElementById('dog-kennel').value, // 新增：犬舍号
                            kennelArea: document.getElementById('dog-kennel-area').value || null, // 新增：犬舍区域
                            origin: document.getElementById('dog-origin').value || null,
                            trainer: document.getElementById('dog-trainer').value || null,
                            health: document.getElementById('dog-health').value,
                            status: document.getElementById('dog-status').value,
                            notes: document.getElementById('dog-notes').value || '',
                            fatherId: fatherId,
                            fatherName: fatherName,
                            motherId: motherId,
                            motherName: motherName,
                            createdDate: now,
                            updatedDate: now
                        };
                        
                        system.dogs[dogId] = newDog;
                        
                        if (saveData()) {
                            showAlert(`犬只 "${newDog.name}" 添加成功！`, 'success');
                            updateDashboard();
                            populateDogSelects();
                            renderDogList();
                            resetAddDogForm();
                            
                            // 自动切换到查看犬只页面
                            setTimeout(() => switchSection('view-dogs'), 1000);
                        }
                    });
                }
                
                // 预览犬只信息
                const previewDogBtn = document.getElementById('preview-dog');
                if (previewDogBtn) {
                    previewDogBtn.addEventListener('click', function() {
                        const name = document.getElementById('dog-name').value;
                        const breed = document.getElementById('dog-breed').value;
                        const gender = document.getElementById('dog-gender').value;
                        const birthDate = document.getElementById('dog-birthdate').value;
                        const kennel = document.getElementById('dog-kennel').value;
                        
                        if (!name || !breed || !gender || !birthDate || !kennel) {
                            showAlert('请先填写基本信息（包括犬舍号）！', 'warning');
                            return;
                        }
                        
                        const previewCard = document.getElementById('preview-card');
                        const previewContent = document.getElementById('dog-preview');
                        
                        const age = calculateAge(birthDate);
                        const fatherName = document.getElementById('dog-father-name').value || '未知';
                        const motherName = document.getElementById('dog-mother-name').value || '未知';
                        
                        previewContent.innerHTML = `
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">犬名</div>
                                <div class="dog-detail-value">${name}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">品种</div>
                                <div class="dog-detail-value">${breed}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">性别</div>
                                <div class="dog-detail-value">${gender === 'male' ? '雄性' : '雌性'}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">犬舍号</div>
                                <div class="dog-detail-value">${kennel}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">父亲</div>
                                <div class="dog-detail-value">${fatherName}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">母亲</div>
                                <div class="dog-detail-value">${motherName}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">年龄</div>
                                <div class="dog-detail-value">${age}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">训导员</div>
                                <div class="dog-detail-value">${document.getElementById('dog-trainer').value || '未指定'}</div>
                            </div>
                            <div class="dog-detail-row">
                                <div class="dog-detail-label">健康状况</div>
                                <div class="dog-detail-value">${document.getElementById('dog-health').value}</div>
                            </div>
                        `;
                        
                        previewCard.style.display = 'block';
                    });
                }
                
                // 搜索犬只
                const searchBtn = document.getElementById('search-btn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', function() {
                        const searchTerm = document.getElementById('search-dogs').value;
                        const breedFilter = document.getElementById('filter-breed').value;
                        const genderFilter = document.getElementById('filter-gender').value;
                        const statusFilter = document.getElementById('filter-status').value;
                        const kennelFilter = document.getElementById('filter-kennel').value;
                        
                        renderDogList({
                            search: searchTerm,
                            breed: breedFilter,
                            gender: genderFilter,
                            status: statusFilter,
                            kennel: kennelFilter
                        });
                    });
                }
                
                // 搜索框回车事件
                const searchDogsInput = document.getElementById('search-dogs');
                if (searchDogsInput) {
                    searchDogsInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            document.getElementById('search-btn').click();
                        }
                    });
                }
                
                // 添加发情记录表单提交
                const addHeatForm = document.getElementById('add-heat-form');
                if (addHeatForm) {
                    addHeatForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const dogId = document.getElementById('heat-dog-id').value;
                        const date = document.getElementById('heat-date').value;
                        const notes = document.getElementById('heat-notes').value;
                        
                        const recordId = generateId('HEAT');
                        const now = new Date().toISOString().split('T')[0];
                        
                        const newRecord = {
                            id: recordId,
                            dogId: dogId,
                            date: date,
                            recordedDate: now,
                            notes: notes || ''
                        };
                        
                        system.heatRecords.push(newRecord);
                        
                        if (saveData()) {
                            showAlert('发情记录添加成功！', 'success');
                            renderHeatRecords();
                            this.reset();
                            updateDashboard();
                        }
                    });
                }
                
                // 添加配种记录表单提交（包含影像检查）
                const addBreedingForm = document.getElementById('add-breeding-form');
                if (addBreedingForm) {
                    addBreedingForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const femaleId = document.getElementById('breeding-female-id').value;
                        const maleId = document.getElementById('breeding-male-id').value;
                        const date = document.getElementById('breeding-date').value;
                        const expectedDate = document.getElementById('breeding-expected-date').value || calculateDueDate(date);
                        const check1Date = document.getElementById('breeding-check1-date').value;
                        const check1Result = document.getElementById('breeding-check1-result').value;
                        const check2Date = document.getElementById('breeding-check2-date').value;
                        const check2Result = document.getElementById('breeding-check2-result').value;
                        const checkNotes = document.getElementById('breeding-check-notes').value;
                        const notes = document.getElementById('breeding-notes').value;
                        
                        const recordId = generateId('BREED');
                        const now = new Date().toISOString().split('T')[0];
                        
                        const newRecord = {
                            id: recordId,
                            femaleId: femaleId,
                            maleId: maleId,
                            date: date,
                            expectedDate: expectedDate,
                            check1Date: check1Date || null,
                            check1Result: check1Result || '',
                            check2Date: check2Date || null,
                            check2Result: check2Result || '',
                            checkNotes: checkNotes || '',
                            actualDate: null,
                            status: 'pregnant',
                            notes: notes || '',
                            recordedDate: now
                        };
                        
                        system.breedingRecords.push(newRecord);
                        
                        if (saveData()) {
                            showAlert('配种记录添加成功！', 'success');
                            renderBreedingRecords();
                            this.reset();
                            populateDogSelects();
                            updateDashboard();
                        }
                    });
                }
                
                // 计算预产期按钮
                const calculateDueDateBtn = document.getElementById('calculate-due-date');
                if (calculateDueDateBtn) {
                    calculateDueDateBtn.addEventListener('click', function() {
                        const breedingDate = document.getElementById('breeding-date').value;
                        if (breedingDate) {
                            const dueDate = calculateDueDate(breedingDate);
                            document.getElementById('breeding-expected-date').value = dueDate;
                        } else {
                            showAlert('请先选择配种日期！', 'warning');
                        }
                    });
                }
                
                // 配种日期变化时自动计算预产期
                const breedingDateInput = document.getElementById('breeding-date');
                if (breedingDateInput) {
                    breedingDateInput.addEventListener('change', function() {
                        if (this.value && !document.getElementById('breeding-expected-date').value) {
                            const dueDate = calculateDueDate(this.value);
                            document.getElementById('breeding-expected-date').value = dueDate;
                        }
                    });
                }
                
                // 添加分娩记录表单提交（包含幼犬预约功能）
                const addBirthForm = document.getElementById('add-birth-form');
                if (addBirthForm) {
                    addBirthForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const dogId = document.getElementById('birth-female-id').value;
                        const breedingId = document.getElementById('birth-breeding-id').value;
                        const date = document.getElementById('birth-date').value;
                        const puppyCount = parseInt(document.getElementById('birth-puppy-count').value);
                        const notes = document.getElementById('birth-notes').value;
                        
                        // 获取幼犬预约信息
                        const dewormDate = document.getElementById('puppy-deworm-date').value;
                        const vaccineDate = document.getElementById('puppy-vaccine-date').value;
                        const scheduleNotes = document.getElementById('puppy-schedule-notes').value;
                        
                        // 收集幼犬详细信息
                        const puppyDetails = [];
                        const puppyInputs = document.querySelectorAll('.puppy-detail');
                        puppyInputs.forEach(input => {
                            const puppyData = {
                                gender: input.querySelector('.puppy-gender').value,
                                color: input.querySelector('.puppy-color').value,
                                weight: input.querySelector('.puppy-weight').value,
                                healthStatus: input.querySelector('.puppy-health').value
                            };
                            puppyDetails.push(puppyData);
                        });
                        
                        const recordId = generateId('BIRTH');
                        const now = new Date().toISOString().split('T')[0];
                        
                        const newRecord = {
                            id: recordId,
                            dogId: dogId,
                            breedingId: breedingId || null,
                            date: date,
                            puppyCount: puppyCount,
                            puppyDetails: puppyDetails,
                            notes: notes || '',
                            recordedDate: now
                        };
                        
                        system.birthRecords.push(newRecord);
                        
                        // 添加幼犬预约记录
                        if (dewormDate || vaccineDate) {
                            const scheduleId = generateId('SCHEDULE');
                            const scheduleRecord = {
                                id: scheduleId,
                                birthRecordId: recordId,
                                motherId: dogId,
                                dewormDate: dewormDate || null,
                                vaccineDate: vaccineDate || null,
                                notes: scheduleNotes || '',
                                recordedDate: now
                            };
                            system.puppySchedules.push(scheduleRecord);
                        }
                        
                        // 更新对应的配种记录状态
                        if (breedingId) {
                            const breedingRecord = system.breedingRecords.find(r => r.id === breedingId);
                            if (breedingRecord) {
                                breedingRecord.status = 'delivered';
                                breedingRecord.actualDate = date;
                                breedingRecord.puppyCount = puppyCount;
                            }
                        }
                        
                        if (saveData()) {
                            showAlert('分娩记录添加成功！', 'success');
                            renderBirthRecords();
                            renderBreedingRecords();
                            this.reset();
                            
                            // 清除幼犬详细信息
                            const puppyList = document.getElementById('puppy-details-list');
                            puppyList.innerHTML = '';
                            
                            // 清除预约信息
                            document.getElementById('puppy-deworm-date').value = '';
                            document.getElementById('puppy-vaccine-date').value = '';
                            document.getElementById('puppy-schedule-notes').value = '';
                            
                            updateDashboard();
                        }
                    });
                }
                
                // 添加幼犬详细信息按钮
                const addPuppyDetailBtn = document.getElementById('add-puppy-detail');
                if (addPuppyDetailBtn) {
                    addPuppyDetailBtn.addEventListener('click', function() {
                        const puppyList = document.getElementById('puppy-details-list');
                        const puppyCount = puppyList.children.length + 1;
                        
                        const puppyDetail = document.createElement('div');
                        puppyDetail.className = 'puppy-detail';
                        puppyDetail.style.marginBottom = '15px';
                        puppyDetail.style.padding = '15px';
                        puppyDetail.style.backgroundColor = '#f8f9fa';
                        puppyDetail.style.borderRadius = '6px';
                        
                        puppyDetail.innerHTML = `
                            <h5 style="margin-bottom: 10px;">幼犬 #${puppyCount}</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>性别</label>
                                    <select class="puppy-gender" style="width: 100%;">
                                        <option value="male">雄性</option>
                                        <option value="female">雌性</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>毛色</label>
                                    <input type="text" class="puppy-color" placeholder="毛色">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>体重(kg)</label>
                                    <input type="number" step="0.1" class="puppy-weight" placeholder="体重">
                                </div>
                                <div class="form-group">
                                    <label>健康状况</label>
                                    <select class="puppy-health" style="width: 100%;">
                                        <option value="健康">健康</option>
                                        <option value="良好">良好</option>
                                        <option value="一般">一般</option>
                                        <option value="需关注">需关注</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger remove-puppy-btn" style="margin-top: 10px;"><i class="fas fa-trash"></i> 删除此幼犬</button>
                        `;
                        
                        puppyList.appendChild(puppyDetail);
                        
                        // 添加删除按钮事件
                        puppyDetail.querySelector('.remove-puppy-btn').addEventListener('click', function() {
                            puppyDetail.remove();
                            // 重新编号
                            const puppies = puppyList.querySelectorAll('.puppy-detail');
                            puppies.forEach((pup, index) => {
                                pup.querySelector('h5').textContent = `幼犬 #${index + 1}`;
                            });
                        });
                    });
                }
                
                // 快速添加雌性犬按钮
                const quickAddMotherBtn = document.getElementById('quick-add-mother-btn');
                if (quickAddMotherBtn) {
                    quickAddMotherBtn.addEventListener('click', quickAddMother);
                }
                
                // 关闭快速添加雌性犬模态框
                const closeQuickAddMotherBtn = document.getElementById('close-quick-add-mother');
                if (closeQuickAddMotherBtn) {
                    closeQuickAddMotherBtn.addEventListener('click', function() {
                        document.getElementById('quick-add-mother-modal').classList.remove('active');
                        document.getElementById('quick-add-mother-form').reset();
                    });
                }
                
                const cancelQuickAddMotherBtn = document.getElementById('cancel-quick-add-mother');
                if (cancelQuickAddMotherBtn) {
                    cancelQuickAddMotherBtn.addEventListener('click', function() {
                        document.getElementById('quick-add-mother-modal').classList.remove('active');
                        document.getElementById('quick-add-mother-form').reset();
                    });
                }
                
                // 母犬选择变化事件
                const motherDogSelect = document.getElementById('mother-dog-select');
                if (motherDogSelect) {
                    motherDogSelect.addEventListener('change', function() {
                        const motherId = this.value;
                        const motherBirthSelect = document.getElementById('mother-birth-select');
                        
                        if (!motherId) {
                            motherBirthSelect.innerHTML = '<option value="">请先选择母犬</option>';
                            updateMotherPuppyList(null);
                            return;
                        }
                        
                        // 更新分娩记录选择框
                        motherBirthSelect.innerHTML = '<option value="">所有分娩记录</option>';
                        
                        const birthRecords = system.birthRecords.filter(record => record.dogId === motherId);
                        birthRecords.forEach(record => {
                            const option = document.createElement('option');
                            option.value = record.id;
                            option.textContent = `${record.date} (${record.puppyCount}只幼犬)`;
                            motherBirthSelect.appendChild(option);
                        });
                        
                        // 更新幼犬列表
                        updateMotherPuppyList(motherId);
                    });
                }
                
                // 母犬分娩记录选择变化事件
                const motherBirthSelect = document.getElementById('mother-birth-select');
                if (motherBirthSelect) {
                    motherBirthSelect.addEventListener('change', function() {
                        const motherId = document.getElementById('mother-dog-select').value;
                        const birthRecordId = this.value;
                        
                        if (motherId) {
                            updateMotherPuppyList(motherId, birthRecordId || null);
                        }
                    });
                }
                
                // 新增：疫苗类型选择变化事件
                const vaccinationTypeSelect = document.getElementById('vaccination-type');
                if (vaccinationTypeSelect) {
                    vaccinationTypeSelect.addEventListener('change', function() {
                        const customVaccineContainer = document.getElementById('custom-vaccine-container');
                        const customVaccineName = document.getElementById('custom-vaccine-name');
                        
                        if (this.value === '其他') {
                            // 显示手动输入框
                            customVaccineContainer.classList.add('active');
                            customVaccineName.required = true;
                            customVaccineName.focus();
                        } else {
                            // 隐藏手动输入框
                            customVaccineContainer.classList.remove('active');
                            customVaccineName.required = false;
                            customVaccineName.value = '';
                            
                            // 疫苗日期或类型变化时自动计算下次日期
                            const vaccineDate = document.getElementById('vaccination-date').value;
                            if (this.value && vaccineDate && !document.getElementById('next-vaccination-date').value) {
                                const nextDate = calculateNextVaccinationDate(vaccineDate, this.value);
                                document.getElementById('next-vaccination-date').value = nextDate;
                            }
                        }
                        
                        // 更新快速选择按钮的激活状态
                        const quickSelect = document.getElementById('vaccine-quick-select');
                        if (quickSelect) {
                            quickSelect.querySelectorAll('.vaccine-quick-btn').forEach(btn => {
                                btn.classList.remove('active');
                                if (btn.dataset.vaccine === this.value) {
                                    btn.classList.add('active');
                                }
                            });
                        }
                    });
                }
                
                // 新增：手动输入疫苗类型变化事件
                const customVaccineNameInput = document.getElementById('custom-vaccine-name');
                if (customVaccineNameInput) {
                    customVaccineNameInput.addEventListener('input', function() {
                        // 当手动输入疫苗类型时，更新选择框的值
                        if (this.value.trim() !== '') {
                            // 更新快速选择按钮的激活状态
                            const quickSelect = document.getElementById('vaccine-quick-select');
                            if (quickSelect) {
                                quickSelect.querySelectorAll('.vaccine-quick-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                    if (btn.dataset.vaccine === this.value.trim()) {
                                        btn.classList.add('active');
                                    }
                                });
                            }
                        }
                    });
                }
                
                // 添加免疫记录表单提交（包含母犬关联幼犬功能）
                const addVaccinationForm = document.getElementById('add-vaccination-form');
                if (addVaccinationForm) {
                    addVaccinationForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const dogId = document.getElementById('vaccination-dog-id').value;
                        let vaccineType = document.getElementById('vaccination-type').value;
                        const customVaccineName = document.getElementById('custom-vaccine-name').value.trim();
                        const date = document.getElementById('vaccination-date').value;
                        const nextDate = document.getElementById('next-vaccination-date').value;
                        const notes = document.getElementById('vaccination-notes').value;
                        
                        // 如果选择了"其他"，则使用手动输入的疫苗类型
                        if (vaccineType === '其他') {
                            if (!customVaccineName) {
                                showAlert('请输入疫苗类型名称！', 'warning');
                                document.getElementById('custom-vaccine-name').focus();
                                return;
                            }
                            vaccineType = customVaccineName;
                        }
                        
                        // 计算下次免疫日期（如果未提供）
                        let calculatedNextDate = nextDate;
                        if (!calculatedNextDate && date && vaccineType) {
                            calculatedNextDate = calculateNextVaccinationDate(date, vaccineType);
                        }
                        
                        let recordsCreated = 0;
                        
                        // 检查是否通过母犬选择了幼犬
                        const selectedPuppies = document.querySelectorAll('#puppy-list input[type="checkbox"]:checked');
                        if (selectedPuppies.length > 0) {
                            // 为选中的幼犬创建免疫记录
                            const success = createVaccinationForPuppies(vaccineType, date, calculatedNextDate, notes);
                            if (success) {
                                recordsCreated = selectedPuppies.length;
                            }
                        }
                        
                        // 如果也选择了单独的犬只，为其创建免疫记录
                        if (dogId) {
                            const recordId = generateId('VACC');
                            const now = new Date().toISOString().split('T')[0];
                            
                            const newRecord = {
                                id: recordId,
                                dogId: dogId,
                                type: vaccineType,
                                date: date,
                                nextDate: calculatedNextDate,
                                notes: notes || '',
                                recordedDate: now
                            };
                            
                            system.vaccinationRecords.push(newRecord);
                            recordsCreated++;
                        }
                        
                        if (recordsCreated > 0) {
                            if (saveData()) {
                                showAlert(`成功创建 ${recordsCreated} 条免疫记录！`, 'success');
                                renderVaccinationRecords();
                                this.reset();
                                
                                // 重置手动输入疫苗类型容器
                                document.getElementById('custom-vaccine-container').classList.remove('active');
                                document.getElementById('custom-vaccine-name').value = '';
                                
                                // 重置母犬选择
                                document.getElementById('mother-dog-select').value = '';
                                document.getElementById('mother-birth-select').innerHTML = '<option value="">请先选择母犬</option>';
                                document.getElementById('puppy-selection-container').style.display = 'none';
                                document.getElementById('puppy-list').innerHTML = '';
                                
                                updateDashboard();
                            }
                        } else {
                            showAlert('请选择犬只或通过母犬选择幼犬！', 'warning');
                        }
                    });
                }
                
                // 计算下次免疫日期按钮
                const calculateNextVaccinationBtn = document.getElementById('calculate-next-vaccination');
                if (calculateNextVaccinationBtn) {
                    calculateNextVaccinationBtn.addEventListener('click', function() {
                        const vaccineDate = document.getElementById('vaccination-date').value;
                        let vaccineType = document.getElementById('vaccination-type').value;
                        const customVaccineName = document.getElementById('custom-vaccine-name').value.trim();
                        
                        // 如果选择了"其他"，则使用手动输入的疫苗类型
                        if (vaccineType === '其他') {
                            if (!customVaccineName) {
                                showAlert('请输入疫苗类型名称！', 'warning');
                                document.getElementById('custom-vaccine-name').focus();
                                return;
                            }
                            vaccineType = customVaccineName;
                        }
                        
                        if (vaccineDate && vaccineType) {
                            const nextDate = calculateNextVaccinationDate(vaccineDate, vaccineType);
                            document.getElementById('next-vaccination-date').value = nextDate;
                        } else {
                            showAlert('请先选择免疫日期和疫苗类型！', 'warning');
                        }
                    });
                }
                
                // 疫苗日期变化时自动计算下次日期
                const vaccinationDateInput = document.getElementById('vaccination-date');
                if (vaccinationDateInput) {
                    vaccinationDateInput.addEventListener('change', function() {
                        let vaccineType = document.getElementById('vaccination-type').value;
                        const customVaccineName = document.getElementById('custom-vaccine-name').value.trim();
                        
                        // 如果选择了"其他"，则使用手动输入的疫苗类型
                        if (vaccineType === '其他') {
                            if (!customVaccineName) {
                                return; // 没有输入自定义疫苗类型，不计算
                            }
                            vaccineType = customVaccineName;
                        }
                        
                        if (this.value && vaccineType && !document.getElementById('next-vaccination-date').value) {
                            const nextDate = calculateNextVaccinationDate(this.value, vaccineType);
                            document.getElementById('next-vaccination-date').value = nextDate;
                        }
                    });
                }
                
                // 刷新统计按钮
                const refreshStatsBtn = document.getElementById('refresh-stats');
                if (refreshStatsBtn) {
                    refreshStatsBtn.addEventListener('click', updateDashboard);
                }
                
                // 快速添加犬只按钮
                const quickAddDogBtn = document.getElementById('quick-add-dog');
                if (quickAddDogBtn) {
                    quickAddDogBtn.addEventListener('click', function() {
                        switchSection('add-dog');
                    });
                }
                
                // 生成详细报告按钮
                const generateReportBtn = document.getElementById('generate-report');
                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', function() {
                        switchSection('reports');
                    });
                }
                
                // 生成统计报告按钮
                const generateStatReportBtn = document.getElementById('generate-stat-report');
                if (generateStatReportBtn) {
                    generateStatReportBtn.addEventListener('click', function() {
                        const reportType = document.getElementById('report-type').value;
                        const reportPeriod = document.getElementById('report-period').value;
                        
                        generateReport(reportType, reportPeriod);
                    });
                }
                
                // 导出数据按钮
                const exportDogsBtn = document.getElementById('export-dogs');
                if (exportDogsBtn) {
                    exportDogsBtn.addEventListener('click', exportDataAsJSON);
                }
                
                // 备份数据按钮
                const backupDataBtn = document.getElementById('backup-data');
                if (backupDataBtn) {
                    backupDataBtn.addEventListener('click', function() {
                        const backupKey = createBackup();
                        showAlert(`数据备份成功！备份ID: ${backupKey}`, 'success');
                    });
                }
                
                // 导出JSON按钮
                const exportJsonBtn = document.getElementById('export-json');
                if (exportJsonBtn) {
                    exportJsonBtn.addEventListener('click', exportDataAsJSON);
                }
                
                // 自动备份切换按钮
                const autoBackupToggleBtn = document.getElementById('auto-backup-toggle');
                if (autoBackupToggleBtn) {
                    autoBackupToggleBtn.addEventListener('click', function() {
                        system.settings.autoBackup = !system.settings.autoBackup;
                        saveSettings();
                        showAlert(`自动备份已${system.settings.autoBackup ? '开启' : '关闭'}！`, 'success');
                    });
                }
                
                // 恢复备份按钮
                const restoreBackupBtn = document.getElementById('restore-backup');
                if (restoreBackupBtn) {
                    restoreBackupBtn.addEventListener('click', function() {
                        const fileInput = document.getElementById('backup-file');
                        if (fileInput.files.length > 0) {
                            importDataFromJSON(fileInput.files[0]);
                        } else {
                            showAlert('请先选择备份文件！', 'warning');
                        }
                    });
                }
                
                // 清空所有数据按钮
                const clearDataBtn = document.getElementById('clear-data');
                if (clearDataBtn) {
                    clearDataBtn.addEventListener('click', function() {
                        showConfirmModal(
                            '确定要清空所有数据吗？此操作不可恢复！',
                            function() {
                                localStorage.removeItem('dogBreedingSystem');
                                showAlert('所有数据已清空！系统将重新加载。', 'success');
                                
                                // 重新加载页面
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            }
                        );
                    });
                }
                
                // 保存设置按钮
                const saveSettingsBtn = document.getElementById('save-settings');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', function() {
                        system.settings.theme = document.getElementById('system-theme').value;
                        system.settings.reminderDays = parseInt(document.getElementById('reminder-days').value) || 30;
                        saveSettings();
                    });
                }
                
                // 恢复默认设置按钮
                const resetSettingsBtn = document.getElementById('reset-settings');
                if (resetSettingsBtn) {
                    resetSettingsBtn.addEventListener('click', function() {
                        system.settings = {
                            theme: 'light',
                            reminderDays: 30,
                            autoBackup: false
                        };
                        saveSettings();
                    });
                }
                
                // 关闭模态框按钮
                const closeDogDetailBtn = document.getElementById('close-dog-detail');
                if (closeDogDetailBtn) {
                    closeDogDetailBtn.addEventListener('click', function() {
                        document.getElementById('dog-detail-modal').classList.remove('active');
                    });
                }
                
                const closeConfirmBtn = document.getElementById('close-confirm');
                if (closeConfirmBtn) {
                    closeConfirmBtn.addEventListener('click', function() {
                        document.getElementById('confirm-modal').classList.remove('active');
                    });
                }
                
                // 点击模态框外部关闭
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
                
                // 初始化备份列表
                updateBackupList();
                
                // ==================== Excel导出事件监听器 ====================
                
                // 查看犬只页面的导出按钮
                const exportExcelCurrentBtn = document.getElementById('export-excel-current');
                if (exportExcelCurrentBtn) {
                    exportExcelCurrentBtn.addEventListener('click', function() {
                        try {
                            // 获取当前筛选条件
                            const searchTerm = document.getElementById('search-dogs').value;
                            const breedFilter = document.getElementById('filter-breed').value;
                            const genderFilter = document.getElementById('filter-gender').value;
                            const statusFilter = document.getElementById('filter-status').value;
                            const kennelFilter = document.getElementById('filter-kennel').value;
                            
                            // 筛选犬只
                            const filteredDogs = Object.values(system.dogs).filter(dog => {
                                if (searchTerm) {
                                    const term = searchTerm.toLowerCase();
                                    if (!(
                                        dog.name.toLowerCase().includes(term) ||
                                        dog.breed.toLowerCase().includes(term) ||
                                        (dog.trainer && dog.trainer.toLowerCase().includes(term)) ||
                                        (dog.chipId && dog.chipId.toLowerCase().includes(term)) ||
                                        (dog.kennel && dog.kennel.toLowerCase().includes(term)) || // 新增：犬舍号搜索
                                        (dog.fatherName && dog.fatherName.toLowerCase().includes(term)) ||
                                        (dog.motherName && dog.motherName.toLowerCase().includes(term))
                                    )) {
                                        return false;
                                    }
                                }
                                
                                if (breedFilter && dog.breed !== breedFilter) {
                                    return false;
                                }
                                
                                if (genderFilter && dog.gender !== genderFilter) {
                                    return false;
                                }
                                
                                if (statusFilter && dog.status !== statusFilter) {
                                    return false;
                                }
                                
                                if (kennelFilter && dog.kennel !== kennelFilter) {
                                    return false;
                                }
                                
                                return true;
                            });
                            
                            if (filteredDogs.length === 0) {
                                showAlert('当前筛选条件下没有犬只数据可导出！', 'warning');
                                return;
                            }
                            
                            // 准备Excel数据（包含父母信息和犬舍号）
                            const excelData = filteredDogs.map(dog => {
                                // 检查是否怀孕
                                const isPregnant = system.breedingRecords.some(record => 
                                    record.femaleId === dog.id && record.status === 'pregnant'
                                );
                                
                                // 获取父母犬只对象
                                const fatherDog = dog.fatherId ? system.dogs[dog.fatherId] : null;
                                const motherDog = dog.motherId ? system.dogs[dog.motherId] : null;
                                
                                return {
                                    '犬名': dog.name,
                                    '芯片ID': dog.chipId || '',
                                    '品种': dog.breed,
                                    '性别': dog.gender === 'male' ? '雄性' : '雌性',
                                    '犬舍号': dog.kennel || '',
                                    '犬舍区域': dog.kennelArea || '',
                                    '出生日期': dog.birthDate,
                                    '年龄': calculateAge(dog.birthDate),
                                    '父亲': fatherDog ? `${fatherDog.name} (${fatherDog.id})` : dog.fatherName || '',
                                    '母亲': motherDog ? `${motherDog.name} (${motherDog.id})` : dog.motherName || '',
                                    '毛色': dog.color || '',
                                    '来源': dog.origin || '',
                                    '训导员': dog.trainer || '',
                                    '健康状况': dog.health || '',
                                    '当前状态': dog.status || '',
                                    '是否怀孕': isPregnant && dog.gender === 'female' ? '是' : '否',
                                    '备注': dog.notes || '',
                                    '创建日期': dog.createdDate || '',
                                    '最后更新': dog.updatedDate || ''
                                };
                            });
                            
                            // 创建工作簿
                            const wb = XLSX.utils.book_new();
                            const ws = XLSX.utils.json_to_sheet(excelData);
                            XLSX.utils.book_append_sheet(wb, ws, '犬只列表');
                            
                            // 生成Excel文件并下载
                            XLSX.writeFile(wb, `警犬列表_${new Date().toISOString().split('T')[0]}.xlsx`);
                            
                            showAlert(`成功导出 ${filteredDogs.length} 条犬只记录到Excel！`, 'success');
                        } catch (error) {
                            console.error('导出Excel失败:', error);
                            showAlert('导出Excel失败，请重试！', 'danger');
                        }
                    });
                }
                
                const exportExcelAllBtn = document.getElementById('export-excel-all');
                if (exportExcelAllBtn) {
                    exportExcelAllBtn.addEventListener('click', function() {
                        try {
                            const allDogs = Object.values(system.dogs);
                            
                            if (allDogs.length === 0) {
                                showAlert('系统中没有犬只数据可导出！', 'warning');
                                return;
                            }
                            
                            const excelData = allDogs.map(dog => {
                                // 检查是否怀孕
                                const isPregnant = system.breedingRecords.some(record => 
                                    record.femaleId === dog.id && record.status === 'pregnant'
                                );
                                
                                // 获取父母犬只对象
                                const fatherDog = dog.fatherId ? system.dogs[dog.fatherId] : null;
                                const motherDog = dog.motherId ? system.dogs[dog.motherId] : null;
                                
                                return {
                                    '犬名': dog.name,
                                    '芯片ID': dog.chipId || '',
                                    '品种': dog.breed,
                                    '性别': dog.gender === 'male' ? '雄性' : '雌性',
                                    '犬舍号': dog.kennel || '',
                                    '犬舍区域': dog.kennelArea || '',
                                    '出生日期': dog.birthDate,
                                    '年龄': calculateAge(dog.birthDate),
                                    '父亲': fatherDog ? `${fatherDog.name} (${fatherDog.id})` : dog.fatherName || '',
                                    '母亲': motherDog ? `${motherDog.name} (${motherDog.id})` : dog.motherName || '',
                                    '毛色': dog.color || '',
                                    '来源': dog.origin || '',
                                    '训导员': dog.trainer || '',
                                    '健康状况': dog.health || '',
                                    '当前状态': dog.status || '',
                                    '是否怀孕': isPregnant && dog.gender === 'female' ? '是' : '否',
                                    '备注': dog.notes || '',
                                    '创建日期': dog.createdDate || '',
                                    '最后更新': dog.updatedDate || ''
                                };
                            });
                            
                            const wb = XLSX.utils.book_new();
                            const ws = XLSX.utils.json_to_sheet(excelData);
                            XLSX.utils.book_append_sheet(wb, ws, '全部犬只');
                            XLSX.writeFile(wb, `全部警犬_${new Date().toISOString().split('T')[0]}.xlsx`);
                            
                            showAlert(`成功导出 ${allDogs.length} 条犬只记录到Excel！`, 'success');
                        } catch (error) {
                            console.error('导出Excel失败:', error);
                            showAlert('导出Excel失败，请重试！', 'danger');
                        }
                    });
                }
                
                const exportExcelDetailedBtn = document.getElementById('export-excel-detailed');
                if (exportExcelDetailedBtn) {
                    exportExcelDetailedBtn.addEventListener('click', function() {
                        try {
                            const allDogs = Object.values(system.dogs);
                            
                            if (allDogs.length === 0) {
                                showAlert('系统中没有犬只数据可导出！', 'warning');
                                return;
                            }
                            
                            // 创建工作簿
                            const wb = XLSX.utils.book_new();
                            
                            // 1. 犬只基本信息表（包含父母信息和犬舍号）
                            const dogsData = allDogs.map(dog => {
                                // 检查是否怀孕
                                const isPregnant = system.breedingRecords.some(record => 
                                    record.femaleId === dog.id && record.status === 'pregnant'
                                );
                                
                                // 获取父母犬只对象
                                const fatherDog = dog.fatherId ? system.dogs[dog.fatherId] : null;
                                const motherDog = dog.motherId ? system.dogs[dog.motherId] : null;
                                
                                return {
                                    '犬名': dog.name,
                                    '芯片ID': dog.chipId || '',
                                    '品种': dog.breed,
                                    '性别': dog.gender === 'male' ? '雄性' : '雌性',
                                    '犬舍号': dog.kennel || '',
                                    '犬舍区域': dog.kennelArea || '',
                                    '出生日期': dog.birthDate,
                                    '年龄': calculateAge(dog.birthDate),
                                    '父亲': fatherDog ? `${fatherDog.name} (${fatherDog.id})` : dog.fatherName || '',
                                    '母亲': motherDog ? `${motherDog.name} (${motherDog.id})` : dog.motherName || '',
                                    '毛色': dog.color || '',
                                    '来源': dog.origin || '',
                                    '训导员': dog.trainer || '',
                                    '健康状况': dog.health || '',
                                    '当前状态': dog.status || '',
                                    '是否怀孕': isPregnant && dog.gender === 'female' ? '是' : '否',
                                    '备注': dog.notes || '',
                                    '创建日期': dog.createdDate || '',
                                    '最后更新': dog.updatedDate || ''
                                };
                            });
                            
                            const dogsWs = XLSX.utils.json_to_sheet(dogsData);
                            XLSX.utils.book_append_sheet(wb, dogsWs, '犬只基本信息');
                            
                            // 2. 免疫记录表
                            if (system.vaccinationRecords.length > 0) {
                                const vaccinationData = system.vaccinationRecords.map(record => {
                                    const dog = system.dogs[record.dogId];
                                    const isCustom = vaccineManager.isCustomVaccineType(record.type);
                                    
                                    return {
                                        '犬名': dog?.name || '未知',
                                        '犬舍号': dog?.kennel || '未知',
                                        '疫苗类型': record.type,
                                        '疫苗类别': isCustom ? '自定义' : '标准',
                                        '免疫日期': record.date,
                                        '下次免疫日期': record.nextDate || '',
                                        '备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const vaccinationWs = XLSX.utils.json_to_sheet(vaccinationData);
                                XLSX.utils.book_append_sheet(wb, vaccinationWs, '免疫记录');
                            }
                            
                            // 3. 繁殖记录表（新增影像检查信息）
                            if (system.breedingRecords.length > 0) {
                                const breedingData = system.breedingRecords.map(record => {
                                    const femaleDog = system.dogs[record.femaleId];
                                    const maleDog = system.dogs[record.maleId];
                                    
                                    let statusText = '';
                                    if (record.status === 'pregnant') statusText = '怀孕中';
                                    else if (record.status === 'delivered') statusText = '已分娩';
                                    else if (record.status === 'cancelled') statusText = '已取消';
                                    
                                    return {
                                        '雌性犬': femaleDog?.name || '未知',
                                        '雌性犬舍号': femaleDog?.kennel || '未知',
                                        '雄性犬': maleDog?.name || '未知',
                                        '雄性犬舍号': maleDog?.kennel || '未知',
                                        '配种日期': record.date,
                                        '预产期': record.expectedDate || '',
                                        '第一次影像检查日期': record.check1Date || '',
                                        '第一次影像检查结果': record.check1Result || '',
                                        '第二次影像检查日期': record.check2Date || '',
                                        '第二次影像检查结果': record.check2Result || '',
                                        '影像检查备注': record.checkNotes || '',
                                        '实际分娩日期': record.actualDate || '',
                                        '幼犬数量': record.puppyCount || '',
                                        '状态': statusText,
                                        '配种备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const breedingWs = XLSX.utils.json_to_sheet(breedingData);
                                XLSX.utils.book_append_sheet(wb, breedingWs, '繁殖记录');
                            }
                            
                            // 4. 分娩记录表（包含幼犬预约信息）
                            if (system.birthRecords.length > 0) {
                                const birthData = system.birthRecords.map(record => {
                                    const dog = system.dogs[record.dogId];
                                    const schedule = system.puppySchedules.find(s => s.birthRecordId === record.id);
                                    
                                    return {
                                        '雌性犬': dog?.name || '未知',
                                        '犬舍号': dog?.kennel || '未知',
                                        '分娩日期': record.date,
                                        '幼犬数量': record.puppyCount,
                                        '首次驱虫预约': schedule?.dewormDate || '未预约',
                                        '首次免疫预约': schedule?.vaccineDate || '未预约',
                                        '备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const birthWs = XLSX.utils.json_to_sheet(birthData);
                                XLSX.utils.book_append_sheet(wb, birthWs, '分娩记录');
                            }
                            
                            // 5. 发情记录表
                            if (system.heatRecords.length > 0) {
                                const heatData = system.heatRecords.map(record => {
                                    const dog = system.dogs[record.dogId];
                                    
                                    return {
                                        '犬名': dog?.name || '未知',
                                        '犬舍号': dog?.kennel || '未知',
                                        '发情日期': record.date,
                                        '备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const heatWs = XLSX.utils.json_to_sheet(heatData);
                                XLSX.utils.book_append_sheet(wb, heatWs, '发情记录');
                            }
                            
                            // 6. 驱虫记录表
                            if (system.dewormingRecords.length > 0) {
                                const dewormingData = system.dewormingRecords.map(record => {
                                    const dog = system.dogs[record.dogId];
                                    
                                    return {
                                        '犬名': dog?.name || '未知',
                                        '犬舍号': dog?.kennel || '未知',
                                        '驱虫日期': record.date,
                                        '下次驱虫日期': record.nextDate || '',
                                        '备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const dewormingWs = XLSX.utils.json_to_sheet(dewormingData);
                                XLSX.utils.book_append_sheet(wb, dewormingWs, '驱虫记录');
                            }
                            
                            // 7. 幼犬预约记录表
                            if (system.puppySchedules.length > 0) {
                                const scheduleData = system.puppySchedules.map(schedule => {
                                    const mother = system.dogs[schedule.motherId];
                                    const birthRecord = system.birthRecords.find(r => r.id === schedule.birthRecordId);
                                    
                                    return {
                                        '母犬': mother?.name || '未知',
                                        '母犬犬舍号': mother?.kennel || '未知',
                                        '分娩记录ID': schedule.birthRecordId,
                                        '分娩日期': birthRecord?.date || '未知',
                                        '首次驱虫预约': schedule.dewormDate || '未预约',
                                        '首次免疫预约': schedule.vaccineDate || '未预约',
                                        '备注': schedule.notes || '',
                                        '记录日期': schedule.recordedDate || ''
                                    };
                                });
                                
                                const scheduleWs = XLSX.utils.json_to_sheet(scheduleData);
                                XLSX.utils.book_append_sheet(wb, scheduleWs, '幼犬预约');
                            }
                            
                            // 生成Excel文件并下载
                            XLSX.writeFile(wb, `警犬详细数据_${new Date().toISOString().split('T')[0]}.xlsx`);
                            
                            showAlert(`成功导出详细数据到Excel，包含 ${allDogs.length} 条犬只记录！`, 'success');
                        } catch (error) {
                            console.error('导出详细Excel失败:', error);
                            showAlert('导出详细Excel失败，请重试！', 'danger');
                        }
                    });
                }
                
                // 数据管理页面的导出按钮
                const exportExcelCompleteBtn = document.getElementById('export-excel-complete');
                if (exportExcelCompleteBtn) {
                    exportExcelCompleteBtn.addEventListener('click', function() {
                        try {
                            // 创建工作簿
                            const wb = XLSX.utils.book_new();
                            
                            // 1. 系统概览表
                            const totalDogs = Object.keys(system.dogs).length;
                            const maleDogs = Object.values(system.dogs).filter(dog => dog.gender === 'male').length;
                            const femaleDogs = Object.values(system.dogs).filter(dog => dog.gender === 'female').length;
                            const pregnantDogs = system.breedingRecords.filter(record => 
                                record.status === 'pregnant' && system.dogs[record.femaleId]
                            ).length;
                            
                            const summaryData = [{
                                '统计项目': '总犬只数',
                                '数值': totalDogs,
                                '备注': ''
                            }, {
                                '统计项目': '雄性犬',
                                '数值': maleDogs,
                                '备注': ''
                            }, {
                                '统计项目': '雌性犬',
                                '数值': femaleDogs,
                                '备注': ''
                            }, {
                                '统计项目': '怀孕犬只',
                                '数值': pregnantDogs,
                                '备注': ''
                            }, {
                                '统计项目': '发情记录数',
                                '数值': system.heatRecords.length,
                                '备注': ''
                            }, {
                                '统计项目': '配种记录数',
                                '数值': system.breedingRecords.length,
                                '备注': ''
                            }, {
                                '统计项目': '分娩记录数',
                                '数值': system.birthRecords.length,
                                '备注': ''
                            }, {
                                '统计项目': '免疫记录数',
                                '数值': system.vaccinationRecords.length,
                                '备注': ''
                            }, {
                                '统计项目': '驱虫记录数',
                                '数值': system.dewormingRecords.length,
                                '备注': ''
                            }, {
                                '统计项目': '幼犬预约数',
                                '数值': system.puppySchedules.length,
                                '备注': ''
                            }];
                            
                            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                            XLSX.utils.book_append_sheet(wb, summaryWs, '系统概览');
                            
                            // 2. 犬只基本信息表（包含父母信息和犬舍号）
                            if (Object.values(system.dogs).length > 0) {
                                const dogsData = Object.values(system.dogs).map(dog => {
                                    // 检查是否怀孕
                                    const isPregnant = system.breedingRecords.some(record => 
                                        record.femaleId === dog.id && record.status === 'pregnant'
                                    );
                                    
                                    // 获取父母犬只对象
                                    const fatherDog = dog.fatherId ? system.dogs[dog.fatherId] : null;
                                    const motherDog = dog.motherId ? system.dogs[dog.motherId] : null;
                                    
                                    return {
                                        '犬名': dog.name,
                                        '芯片ID': dog.chipId || '',
                                        '品种': dog.breed,
                                        '性别': dog.gender === 'male' ? '雄性' : '雌性',
                                        '犬舍号': dog.kennel || '',
                                        '犬舍区域': dog.kennelArea || '',
                                        '出生日期': dog.birthDate,
                                        '年龄': calculateAge(dog.birthDate),
                                        '父亲': fatherDog ? `${fatherDog.name} (${fatherDog.id})` : dog.fatherName || '',
                                        '母亲': motherDog ? `${motherDog.name} (${motherDog.id})` : dog.motherName || '',
                                        '毛色': dog.color || '',
                                        '来源': dog.origin || '',
                                        '训导员': dog.trainer || '',
                                        '健康状况': dog.health || '',
                                        '当前状态': dog.status || '',
                                        '是否怀孕': isPregnant && dog.gender === 'female' ? '是' : '否',
                                        '备注': dog.notes || '',
                                        '创建日期': dog.createdDate || '',
                                        '最后更新': dog.updatedDate || ''
                                    };
                                });
                                
                                const dogsWs = XLSX.utils.json_to_sheet(dogsData);
                                XLSX.utils.book_append_sheet(wb, dogsWs, '犬只信息');
                            }
                            
                            // 3. 品种统计表
                            const breedCounts = {};
                            Object.values(system.dogs).forEach(dog => {
                                breedCounts[dog.breed] = (breedCounts[dog.breed] || 0) + 1;
                            });
                            
                            const breedData = Object.entries(breedCounts).map(([breed, count]) => ({
                                '品种': breed,
                                '数量': count,
                                '占比': `${((count / totalDogs) * 100).toFixed(2)}%`
                            }));
                            
                            if (breedData.length > 0) {
                                const breedWs = XLSX.utils.json_to_sheet(breedData);
                                XLSX.utils.book_append_sheet(wb, breedWs, '品种统计');
                            }
                            
                            // 4. 犬舍统计表
                            const kennelCounts = {};
                            Object.values(system.dogs).forEach(dog => {
                                const kennel = dog.kennel || '未分配';
                                kennelCounts[kennel] = (kennelCounts[kennel] || 0) + 1;
                            });
                            
                            const kennelData = Object.entries(kennelCounts).map(([kennel, count]) => ({
                                '犬舍号': kennel,
                                '犬只数量': count,
                                '占比': `${((count / totalDogs) * 100).toFixed(2)}%`
                            }));
                            
                            if (kennelData.length > 0) {
                                const kennelWs = XLSX.utils.json_to_sheet(kennelData);
                                XLSX.utils.book_append_sheet(wb, kennelWs, '犬舍统计');
                            }
                            
                            // 5. 免疫记录表
                            if (system.vaccinationRecords.length > 0) {
                                const vaccinationData = system.vaccinationRecords.map(record => {
                                    const dog = system.dogs[record.dogId];
                                    const isCustom = vaccineManager.isCustomVaccineType(record.type);
                                    
                                    return {
                                        '犬名': dog?.name || '未知',
                                        '犬舍号': dog?.kennel || '未知',
                                        '疫苗类型': record.type,
                                        '疫苗类别': isCustom ? '自定义' : '标准',
                                        '免疫日期': record.date,
                                        '下次免疫日期': record.nextDate || '',
                                        '备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const vaccinationWs = XLSX.utils.json_to_sheet(vaccinationData);
                                XLSX.utils.book_append_sheet(wb, vaccinationWs, '免疫记录');
                            }
                            
                            // 6. 繁殖记录表（包含影像检查信息）
                            if (system.breedingRecords.length > 0) {
                                const breedingData = system.breedingRecords.map(record => {
                                    const femaleDog = system.dogs[record.femaleId];
                                    const maleDog = system.dogs[record.maleId];
                                    
                                    let statusText = '';
                                    if (record.status === 'pregnant') statusText = '怀孕中';
                                    else if (record.status === 'delivered') statusText = '已分娩';
                                    else if (record.status === 'cancelled') statusText = '已取消';
                                    
                                    return {
                                        '雌性犬': femaleDog?.name || '未知',
                                        '雌性犬舍号': femaleDog?.kennel || '未知',
                                        '雄性犬': maleDog?.name || '未知',
                                        '雄性犬舍号': maleDog?.kennel || '未知',
                                        '配种日期': record.date,
                                        '预产期': record.expectedDate || '',
                                        '第一次影像检查日期': record.check1Date || '',
                                        '第一次影像检查结果': record.check1Result || '',
                                        '第二次影像检查日期': record.check2Date || '',
                                        '第二次影像检查结果': record.check2Result || '',
                                        '影像检查备注': record.checkNotes || '',
                                        '实际分娩日期': record.actualDate || '',
                                        '幼犬数量': record.puppyCount || '',
                                        '状态': statusText,
                                        '配种备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const breedingWs = XLSX.utils.json_to_sheet(breedingData);
                                XLSX.utils.book_append_sheet(wb, breedingWs, '繁殖记录');
                            }
                            
                            // 7. 分娩记录表
                            if (system.birthRecords.length > 0) {
                                const birthData = system.birthRecords.map(record => {
                                    const dog = system.dogs[record.dogId];
                                    const breedingRecord = system.breedingRecords.find(r => r.id === record.breedingId);
                                    const schedule = system.puppySchedules.find(s => s.birthRecordId === record.id);
                                    
                                    return {
                                        '雌性犬': dog?.name || '未知',
                                        '犬舍号': dog?.kennel || '未知',
                                        '分娩日期': record.date,
                                        '幼犬数量': record.puppyCount,
                                        '配种日期': breedingRecord ? breedingRecord.date : '',
                                        '首次驱虫预约': schedule?.dewormDate || '未预约',
                                        '首次免疫预约': schedule?.vaccineDate || '未预约',
                                        '备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const birthWs = XLSX.utils.json_to_sheet(birthData);
                                XLSX.utils.book_append_sheet(wb, birthWs, '分娩记录');
                            }
                            
                            // 8. 发情记录表
                            if (system.heatRecords.length > 0) {
                                const heatData = system.heatRecords.map(record => {
                                    const dog = system.dogs[record.dogId];
                                    
                                    return {
                                        '犬名': dog?.name || '未知',
                                        '犬舍号': dog?.kennel || '未知',
                                        '发情日期': record.date,
                                        '备注': record.notes || '',
                                        '记录日期': record.recordedDate || ''
                                    };
                                });
                                
                                const heatWs = XLSX.utils.json_to_sheet(heatData);
                                XLSX.utils.book_append_sheet(wb, heatWs, '发情记录');
                            }
                            
                            // 生成Excel文件并下载
                            XLSX.writeFile(wb, `警犬完整数据_${new Date().toISOString().split('T')[0]}.xlsx`);
                            
                            showAlert(`成功导出完整数据到Excel，包含 ${totalDogs} 条犬只记录！`, 'success');
                        } catch (error) {
                            console.error('导出完整Excel失败:', error);
                            showAlert('导出完整Excel失败，请重试！', 'danger');
                        }
                    });
                }
                
                // 导出犬舍分布按钮
                const exportExcelKennelBtn = document.getElementById('export-excel-kennel');
                if (exportExcelKennelBtn) {
                    exportExcelKennelBtn.addEventListener('click', function() {
                        try {
                            // 统计犬舍分布
                            const kennelStats = {};
                            Object.values(system.dogs).forEach(dog => {
                                const kennel = dog.kennel || '未分配';
                                if (!kennelStats[kennel]) {
                                    kennelStats[kennel] = {
                                        total: 0,
                                        male: 0,
                                        female: 0,
                                        breeds: {},
                                        areas: {},
                                        statuses: {}
                                    };
                                }
                                
                                kennelStats[kennel].total++;
                                if (dog.gender === 'male') kennelStats[kennel].male++;
                                if (dog.gender === 'female') kennelStats[kennel].female++;
                                
                                // 统计品种
                                const breed = dog.breed;
                                if (!kennelStats[kennel].breeds[breed]) {
                                    kennelStats[kennel].breeds[breed] = 0;
                                }
                                kennelStats[kennel].breeds[breed]++;
                                
                                // 统计犬舍区域
                                const area = dog.kennelArea || '未指定';
                                if (!kennelStats[kennel].areas[area]) {
                                    kennelStats[kennel].areas[area] = 0;
                                }
                                kennelStats[kennel].areas[area]++;
                                
                                // 统计状态
                                const status = dog.status || '未知';
                                if (!kennelStats[kennel].statuses[status]) {
                                    kennelStats[kennel].statuses[status] = 0;
                                }
                                kennelStats[kennel].statuses[status]++;
                            });
                            
                            // 准备Excel数据
                            const excelData = [];
                            Object.entries(kennelStats).forEach(([kennel, stats]) => {
                                // 将品种统计转换为字符串
                                const breedList = Object.entries(stats.breeds)
                                    .map(([breed, count]) => `${breed}: ${count}`)
                                    .join('; ');
                                    
                                // 将区域统计转换为字符串
                                const areaList = Object.entries(stats.areas)
                                    .map(([area, count]) => `${area}: ${count}`)
                                    .join('; ');
                                    
                                // 将状态统计转换为字符串
                                const statusList = Object.entries(stats.statuses)
                                    .map(([status, count]) => `${status}: ${count}`)
                                    .join('; ');
                                
                                excelData.push({
                                    '犬舍号': kennel,
                                    '总犬只数': stats.total,
                                    '雄性犬': stats.male,
                                    '雌性犬': stats.female,
                                    '品种分布': breedList,
                                    '区域分布': areaList,
                                    '状态分布': statusList
                                });
                            });
                            
                            // 创建工作簿
                            const wb = XLSX.utils.book_new();
                            const ws = XLSX.utils.json_to_sheet(excelData);
                            XLSX.utils.book_append_sheet(wb, ws, '犬舍分布统计');
                            XLSX.writeFile(wb, `犬舍分布统计_${new Date().toISOString().split('T')[0]}.xlsx`);
                            
                            showAlert(`成功导出犬舍分布统计到Excel！`, 'success');
                        } catch (error) {
                            console.error('导出犬舍分布Excel失败:', error);
                            showAlert('导出犬舍分布Excel失败，请重试！', 'danger');
                        }
                    });
                }
            }
            
            // 初始化系统
            initSystem();
        });
    </script>
</body>
</html>